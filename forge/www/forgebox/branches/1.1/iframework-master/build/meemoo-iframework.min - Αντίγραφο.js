/*! Meemoo Iframework http://meemoo.org/ - v0.3.5 - 2013-09-14 (2:25:53 AM GMT+0300)
* Copyright (c) 2013 Forrest Oliphant; Licensed MIT, AGPL */
(function(){var e=this,t=e._,i={},n=Array.prototype,r=Object.prototype,o=Function.prototype,s=n.push,a=n.slice,l=n.concat,h=r.toString,d=r.hasOwnProperty,u=n.forEach,c=n.map,p=n.reduce,f=n.reduceRight,g=n.filter,m=n.every,v=n.some,w=n.indexOf,b=n.lastIndexOf,y=Array.isArray,k=Object.keys,x=o.bind,I=function(e){return e instanceof I?e:this instanceof I?(this._wrapped=e,void 0):new I(e)};"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=I),exports._=I):e._=I,I.VERSION="1.4.4";var _=I.each=I.forEach=function(e,t,n){if(null!=e)if(u&&e.forEach===u)e.forEach(t,n);else if(e.length===+e.length){for(var r=0,o=e.length;o>r;r++)if(t.call(n,e[r],r,e)===i)return}else for(var s in e)if(I.has(e,s)&&t.call(n,e[s],s,e)===i)return};I.map=I.collect=function(e,t,i){var n=[];return null==e?n:c&&e.map===c?e.map(t,i):(_(e,function(e,r,o){n[n.length]=t.call(i,e,r,o)}),n)};var $="Reduce of empty array with no initial value";I.reduce=I.foldl=I.inject=function(e,t,i,n){var r=arguments.length>2;if(null==e&&(e=[]),p&&e.reduce===p)return n&&(t=I.bind(t,n)),r?e.reduce(t,i):e.reduce(t);if(_(e,function(e,o,s){r?i=t.call(n,i,e,o,s):(i=e,r=!0)}),!r)throw new TypeError($);return i},I.reduceRight=I.foldr=function(e,t,i,n){var r=arguments.length>2;if(null==e&&(e=[]),f&&e.reduceRight===f)return n&&(t=I.bind(t,n)),r?e.reduceRight(t,i):e.reduceRight(t);var o=e.length;if(o!==+o){var s=I.keys(e);o=s.length}if(_(e,function(a,l,h){l=s?s[--o]:--o,r?i=t.call(n,i,e[l],l,h):(i=e[l],r=!0)}),!r)throw new TypeError($);return i},I.find=I.detect=function(e,t,i){var n;return E(e,function(e,r,o){return t.call(i,e,r,o)?(n=e,!0):void 0}),n},I.filter=I.select=function(e,t,i){var n=[];return null==e?n:g&&e.filter===g?e.filter(t,i):(_(e,function(e,r,o){t.call(i,e,r,o)&&(n[n.length]=e)}),n)},I.reject=function(e,t,i){return I.filter(e,function(e,n,r){return!t.call(i,e,n,r)},i)},I.every=I.all=function(e,t,n){t||(t=I.identity);var r=!0;return null==e?r:m&&e.every===m?e.every(t,n):(_(e,function(e,o,s){return(r=r&&t.call(n,e,o,s))?void 0:i}),!!r)};var E=I.some=I.any=function(e,t,n){t||(t=I.identity);var r=!1;return null==e?r:v&&e.some===v?e.some(t,n):(_(e,function(e,o,s){return r||(r=t.call(n,e,o,s))?i:void 0}),!!r)};I.contains=I.include=function(e,t){return null==e?!1:w&&e.indexOf===w?-1!=e.indexOf(t):E(e,function(e){return e===t})},I.invoke=function(e,t){var i=a.call(arguments,2),n=I.isFunction(t);return I.map(e,function(e){return(n?t:e[t]).apply(e,i)})},I.pluck=function(e,t){return I.map(e,function(e){return e[t]})},I.where=function(e,t,i){return I.isEmpty(t)?i?null:[]:I[i?"find":"filter"](e,function(e){for(var i in t)if(t[i]!==e[i])return!1;return!0})},I.findWhere=function(e,t){return I.where(e,t,!0)},I.max=function(e,t,i){if(!t&&I.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.max.apply(Math,e);if(!t&&I.isEmpty(e))return-1/0;var n={computed:-1/0,value:-1/0};return _(e,function(e,r,o){var s=t?t.call(i,e,r,o):e;s>=n.computed&&(n={value:e,computed:s})}),n.value},I.min=function(e,t,i){if(!t&&I.isArray(e)&&e[0]===+e[0]&&65535>e.length)return Math.min.apply(Math,e);if(!t&&I.isEmpty(e))return 1/0;var n={computed:1/0,value:1/0};return _(e,function(e,r,o){var s=t?t.call(i,e,r,o):e;n.computed>s&&(n={value:e,computed:s})}),n.value},I.shuffle=function(e){var t,i=0,n=[];return _(e,function(e){t=I.random(i++),n[i-1]=n[t],n[t]=e}),n};var S=function(e){return I.isFunction(e)?e:function(t){return t[e]}};I.sortBy=function(e,t,i){var n=S(t);return I.pluck(I.map(e,function(e,t,r){return{value:e,index:t,criteria:n.call(i,e,t,r)}}).sort(function(e,t){var i=e.criteria,n=t.criteria;if(i!==n){if(i>n||void 0===i)return 1;if(n>i||void 0===n)return-1}return e.index<t.index?-1:1}),"value")};var C=function(e,t,i,n){var r={},o=S(t||I.identity);return _(e,function(t,s){var a=o.call(i,t,s,e);n(r,a,t)}),r};I.groupBy=function(e,t,i){return C(e,t,i,function(e,t,i){(I.has(e,t)?e[t]:e[t]=[]).push(i)})},I.countBy=function(e,t,i){return C(e,t,i,function(e,t){I.has(e,t)||(e[t]=0),e[t]++})},I.sortedIndex=function(e,t,i,n){i=null==i?I.identity:S(i);for(var r=i.call(n,t),o=0,s=e.length;s>o;){var a=o+s>>>1;r>i.call(n,e[a])?o=a+1:s=a}return o},I.toArray=function(e){return e?I.isArray(e)?a.call(e):e.length===+e.length?I.map(e,I.identity):I.values(e):[]},I.size=function(e){return null==e?0:e.length===+e.length?e.length:I.keys(e).length},I.first=I.head=I.take=function(e,t,i){return null==e?void 0:null==t||i?e[0]:a.call(e,0,t)},I.initial=function(e,t,i){return a.call(e,0,e.length-(null==t||i?1:t))},I.last=function(e,t,i){return null==e?void 0:null==t||i?e[e.length-1]:a.call(e,Math.max(e.length-t,0))},I.rest=I.tail=I.drop=function(e,t,i){return a.call(e,null==t||i?1:t)},I.compact=function(e){return I.filter(e,I.identity)};var N=function(e,t,i){return _(e,function(e){I.isArray(e)?t?s.apply(i,e):N(e,t,i):i.push(e)}),i};I.flatten=function(e,t){return N(e,t,[])},I.without=function(e){return I.difference(e,a.call(arguments,1))},I.uniq=I.unique=function(e,t,i,n){I.isFunction(t)&&(n=i,i=t,t=!1);var r=i?I.map(e,i,n):e,o=[],s=[];return _(r,function(i,n){(t?n&&s[s.length-1]===i:I.contains(s,i))||(s.push(i),o.push(e[n]))}),o},I.union=function(){return I.uniq(l.apply(n,arguments))},I.intersection=function(e){var t=a.call(arguments,1);return I.filter(I.uniq(e),function(e){return I.every(t,function(t){return I.indexOf(t,e)>=0})})},I.difference=function(e){var t=l.apply(n,a.call(arguments,1));return I.filter(e,function(e){return!I.contains(t,e)})},I.zip=function(){for(var e=a.call(arguments),t=I.max(I.pluck(e,"length")),i=Array(t),n=0;t>n;n++)i[n]=I.pluck(e,""+n);return i},I.object=function(e,t){if(null==e)return{};for(var i={},n=0,r=e.length;r>n;n++)t?i[e[n]]=t[n]:i[e[n][0]]=e[n][1];return i},I.indexOf=function(e,t,i){if(null==e)return-1;var n=0,r=e.length;if(i){if("number"!=typeof i)return n=I.sortedIndex(e,t),e[n]===t?n:-1;n=0>i?Math.max(0,r+i):i}if(w&&e.indexOf===w)return e.indexOf(t,i);for(;r>n;n++)if(e[n]===t)return n;return-1},I.lastIndexOf=function(e,t,i){if(null==e)return-1;var n=null!=i;if(b&&e.lastIndexOf===b)return n?e.lastIndexOf(t,i):e.lastIndexOf(t);for(var r=n?i:e.length;r--;)if(e[r]===t)return r;return-1},I.range=function(e,t,i){1>=arguments.length&&(t=e||0,e=0),i=arguments[2]||1;for(var n=Math.max(Math.ceil((t-e)/i),0),r=0,o=Array(n);n>r;)o[r++]=e,e+=i;return o},I.bind=function(e,t){if(e.bind===x&&x)return x.apply(e,a.call(arguments,1));var i=a.call(arguments,2);return function(){return e.apply(t,i.concat(a.call(arguments)))}},I.partial=function(e){var t=a.call(arguments,1);return function(){return e.apply(this,t.concat(a.call(arguments)))}},I.bindAll=function(e){var t=a.call(arguments,1);return 0===t.length&&(t=I.functions(e)),_(t,function(t){e[t]=I.bind(e[t],e)}),e},I.memoize=function(e,t){var i={};return t||(t=I.identity),function(){var n=t.apply(this,arguments);return I.has(i,n)?i[n]:i[n]=e.apply(this,arguments)}},I.delay=function(e,t){var i=a.call(arguments,2);return setTimeout(function(){return e.apply(null,i)},t)},I.defer=function(e){return I.delay.apply(I,[e,1].concat(a.call(arguments,1)))},I.throttle=function(e,t){var i,n,r,o,s=0,a=function(){s=new Date,r=null,o=e.apply(i,n)};return function(){var l=new Date,h=t-(l-s);return i=this,n=arguments,0>=h?(clearTimeout(r),r=null,s=l,o=e.apply(i,n)):r||(r=setTimeout(a,h)),o}},I.debounce=function(e,t,i){var n,r;return function(){var o=this,s=arguments,a=function(){n=null,i||(r=e.apply(o,s))},l=i&&!n;return clearTimeout(n),n=setTimeout(a,t),l&&(r=e.apply(o,s)),r}},I.once=function(e){var t,i=!1;return function(){return i?t:(i=!0,t=e.apply(this,arguments),e=null,t)}},I.wrap=function(e,t){return function(){var i=[e];return s.apply(i,arguments),t.apply(this,i)}},I.compose=function(){var e=arguments;return function(){for(var t=arguments,i=e.length-1;i>=0;i--)t=[e[i].apply(this,t)];return t[0]}},I.after=function(e,t){return 0>=e?t():function(){return 1>--e?t.apply(this,arguments):void 0}},I.keys=k||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var i in e)I.has(e,i)&&(t[t.length]=i);return t},I.values=function(e){var t=[];for(var i in e)I.has(e,i)&&t.push(e[i]);return t},I.pairs=function(e){var t=[];for(var i in e)I.has(e,i)&&t.push([i,e[i]]);return t},I.invert=function(e){var t={};for(var i in e)I.has(e,i)&&(t[e[i]]=i);return t},I.functions=I.methods=function(e){var t=[];for(var i in e)I.isFunction(e[i])&&t.push(i);return t.sort()},I.extend=function(e){return _(a.call(arguments,1),function(t){if(t)for(var i in t)e[i]=t[i]}),e},I.pick=function(e){var t={},i=l.apply(n,a.call(arguments,1));return _(i,function(i){i in e&&(t[i]=e[i])}),t},I.omit=function(e){var t={},i=l.apply(n,a.call(arguments,1));for(var r in e)I.contains(i,r)||(t[r]=e[r]);return t},I.defaults=function(e){return _(a.call(arguments,1),function(t){if(t)for(var i in t)null==e[i]&&(e[i]=t[i])}),e},I.clone=function(e){return I.isObject(e)?I.isArray(e)?e.slice():I.extend({},e):e},I.tap=function(e,t){return t(e),e};var P=function(e,t,i,n){if(e===t)return 0!==e||1/e==1/t;if(null==e||null==t)return e===t;e instanceof I&&(e=e._wrapped),t instanceof I&&(t=t._wrapped);var r=h.call(e);if(r!=h.call(t))return!1;switch(r){case"[object String]":return e==t+"";case"[object Number]":return e!=+e?t!=+t:0==e?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if("object"!=typeof e||"object"!=typeof t)return!1;for(var o=i.length;o--;)if(i[o]==e)return n[o]==t;i.push(e),n.push(t);var s=0,a=!0;if("[object Array]"==r){if(s=e.length,a=s==t.length)for(;s--&&(a=P(e[s],t[s],i,n)););}else{var l=e.constructor,d=t.constructor;if(l!==d&&!(I.isFunction(l)&&l instanceof l&&I.isFunction(d)&&d instanceof d))return!1;for(var u in e)if(I.has(e,u)&&(s++,!(a=I.has(t,u)&&P(e[u],t[u],i,n))))break;if(a){for(u in t)if(I.has(t,u)&&!s--)break;a=!s}}return i.pop(),n.pop(),a};I.isEqual=function(e,t){return P(e,t,[],[])},I.isEmpty=function(e){if(null==e)return!0;if(I.isArray(e)||I.isString(e))return 0===e.length;for(var t in e)if(I.has(e,t))return!1;return!0},I.isElement=function(e){return!(!e||1!==e.nodeType)},I.isArray=y||function(e){return"[object Array]"==h.call(e)},I.isObject=function(e){return e===Object(e)},_(["Arguments","Function","String","Number","Date","RegExp"],function(e){I["is"+e]=function(t){return h.call(t)=="[object "+e+"]"}}),I.isArguments(arguments)||(I.isArguments=function(e){return!(!e||!I.has(e,"callee"))}),true&&(I.isFunction=function(e){return"function"==typeof e}),I.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},I.isNaN=function(e){return I.isNumber(e)&&e!=+e},I.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"==h.call(e)},I.isNull=function(e){return null===e},I.isUndefined=function(e){return void 0===e},I.has=function(e,t){return d.call(e,t)},I.noConflict=function(){return e._=t,this},I.identity=function(e){return e},I.times=function(e,t,i){for(var n=Array(e),r=0;e>r;r++)n[r]=t.call(i,r);return n},I.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))};var G={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};G.unescape=I.invert(G.escape);var O={escape:RegExp("["+I.keys(G.escape).join("")+"]","g"),unescape:RegExp("("+I.keys(G.unescape).join("|")+")","g")};I.each(["escape","unescape"],function(e){I[e]=function(t){return null==t?"":(""+t).replace(O[e],function(t){return G[e][t]})}}),I.result=function(e,t){if(null==e)return null;var i=e[t];return I.isFunction(i)?i.call(e):i},I.mixin=function(e){_(I.functions(e),function(t){var i=I[t]=e[t];I.prototype[t]=function(){var e=[this._wrapped];return s.apply(e,arguments),z.call(this,i.apply(I,e))}})};var T=0;I.uniqueId=function(e){var t=++T+"";return e?e+t:t},I.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var A=/(.)^/,M={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"},L=/\\|'|\r|\n|\t|\u2028|\u2029/g;I.template=function(e,t,i){var n;i=I.defaults({},i,I.templateSettings);var r=RegExp([(i.escape||A).source,(i.interpolate||A).source,(i.evaluate||A).source].join("|")+"|$","g"),o=0,s="__p+='";e.replace(r,function(t,i,n,r,a){return s+=e.slice(o,a).replace(L,function(e){return"\\"+M[e]}),i&&(s+="'+\n((__t=("+i+"))==null?'':_.escape(__t))+\n'"),n&&(s+="'+\n((__t=("+n+"))==null?'':__t)+\n'"),r&&(s+="';\n"+r+"\n__p+='"),o=a+t.length,t}),s+="';\n",i.variable||(s="with(obj||{}){\n"+s+"}\n"),s="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+s+"return __p;\n";try{n=Function(i.variable||"obj","_",s)}catch(a){throw a.source=s,a}if(t)return n(t,I);var l=function(e){return n.call(this,e,I)};return l.source="function("+(i.variable||"obj")+"){\n"+s+"}",l},I.chain=function(e){return I(e).chain()};var z=function(e){return this._chain?I(e).chain():e};I.mixin(I),_(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=n[e];I.prototype[e]=function(){var i=this._wrapped;return t.apply(i,arguments),"shift"!=e&&"splice"!=e||0!==i.length||delete i[0],z.call(this,i)}}),_(["concat","join","slice"],function(e){var t=n[e];I.prototype[e]=function(){return z.call(this,t.apply(this._wrapped,arguments))}}),I.extend(I.prototype,{chain:function(){return this._chain=!0,this},value:function(){return this._wrapped}})}).call(this),function(){var e,t=this,i=t.Backbone,n=[],r=n.push,o=n.slice,s=n.splice;e="undefined"!=typeof exports?exports:t.Backbone={},e.VERSION="1.0.0";var a=t._;a||"undefined"==typeof require||(a=require("underscore")),e.$=t.jQuery||t.Zepto||t.ender||t.$,e.noConflict=function(){return t.Backbone=i,this},e.emulateHTTP=!1,e.emulateJSON=!1;var l=e.Events={on:function(e,t,i){if(!d(this,"on",e,[t,i])||!t)return this;this._events||(this._events={});var n=this._events[e]||(this._events[e]=[]);return n.push({callback:t,context:i,ctx:i||this}),this},once:function(e,t,i){if(!d(this,"once",e,[t,i])||!t)return this;var n=this,r=a.once(function(){n.off(e,r),t.apply(this,arguments)});return r._callback=t,this.on(e,r,i)},off:function(e,t,i){var n,r,o,s,l,h,u,c;if(!this._events||!d(this,"off",e,[t,i]))return this;if(!e&&!t&&!i)return this._events={},this;for(s=e?[e]:a.keys(this._events),l=0,h=s.length;h>l;l++)if(e=s[l],o=this._events[e]){if(this._events[e]=n=[],t||i)for(u=0,c=o.length;c>u;u++)r=o[u],(t&&t!==r.callback&&t!==r.callback._callback||i&&i!==r.context)&&n.push(r);n.length||delete this._events[e]}return this},trigger:function(e){if(!this._events)return this;var t=o.call(arguments,1);if(!d(this,"trigger",e,t))return this;var i=this._events[e],n=this._events.all;return i&&u(i,t),n&&u(n,arguments),this},stopListening:function(e,t,i){var n=this._listeners;if(!n)return this;var r=!t&&!i;"object"==typeof t&&(i=this),e&&((n={})[e._listenerId]=e);for(var o in n)n[o].off(t,i,this),r&&delete this._listeners[o];return this}},h=/\s+/,d=function(e,t,i,n){if(!i)return!0;if("object"==typeof i){for(var r in i)e[t].apply(e,[r,i[r]].concat(n));return!1}if(h.test(i)){for(var o=i.split(h),s=0,a=o.length;a>s;s++)e[t].apply(e,[o[s]].concat(n));return!1}return!0},u=function(e,t){var i,n=-1,r=e.length,o=t[0],s=t[1],a=t[2];switch(t.length){case 0:for(;r>++n;)(i=e[n]).callback.call(i.ctx);return;case 1:for(;r>++n;)(i=e[n]).callback.call(i.ctx,o);return;case 2:for(;r>++n;)(i=e[n]).callback.call(i.ctx,o,s);return;case 3:for(;r>++n;)(i=e[n]).callback.call(i.ctx,o,s,a);return;default:for(;r>++n;)(i=e[n]).callback.apply(i.ctx,t)}},c={listenTo:"on",listenToOnce:"once"};a.each(c,function(e,t){l[t]=function(t,i,n){var r=this._listeners||(this._listeners={}),o=t._listenerId||(t._listenerId=a.uniqueId("l"));return r[o]=t,"object"==typeof i&&(n=this),t[e](i,n,this),this}}),l.bind=l.on,l.unbind=l.off,a.extend(e,l);var p=e.Model=function(e,t){var i,n=e||{};t||(t={}),this.cid=a.uniqueId("c"),this.attributes={},a.extend(this,a.pick(t,f)),t.parse&&(n=this.parse(n,t)||{}),(i=a.result(this,"defaults"))&&(n=a.defaults({},n,i)),this.set(n,t),this.changed={},this.initialize.apply(this,arguments)},f=["url","urlRoot","collection"];a.extend(p.prototype,l,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return a.clone(this.attributes)},sync:function(){return e.sync.apply(this,arguments)},get:function(e){return this.attributes[e]},escape:function(e){return a.escape(this.get(e))},has:function(e){return null!=this.get(e)},set:function(e,t,i){var n,r,o,s,l,h,d,u;if(null==e)return this;if("object"==typeof e?(r=e,i=t):(r={})[e]=t,i||(i={}),!this._validate(r,i))return!1;o=i.unset,l=i.silent,s=[],h=this._changing,this._changing=!0,h||(this._previousAttributes=a.clone(this.attributes),this.changed={}),u=this.attributes,d=this._previousAttributes,this.idAttribute in r&&(this.id=r[this.idAttribute]);for(n in r)t=r[n],a.isEqual(u[n],t)||s.push(n),a.isEqual(d[n],t)?delete this.changed[n]:this.changed[n]=t,o?delete u[n]:u[n]=t;if(!l){s.length&&(this._pending=!0);for(var c=0,p=s.length;p>c;c++)this.trigger("change:"+s[c],this,u[s[c]],i)}if(h)return this;if(!l)for(;this._pending;)this._pending=!1,this.trigger("change",this,i);return this._pending=!1,this._changing=!1,this},unset:function(e,t){return this.set(e,void 0,a.extend({},t,{unset:!0}))},clear:function(e){var t={};for(var i in this.attributes)t[i]=void 0;return this.set(t,a.extend({},e,{unset:!0}))},hasChanged:function(e){return null==e?!a.isEmpty(this.changed):a.has(this.changed,e)},changedAttributes:function(e){if(!e)return this.hasChanged()?a.clone(this.changed):!1;var t,i=!1,n=this._changing?this._previousAttributes:this.attributes;for(var r in e)a.isEqual(n[r],t=e[r])||((i||(i={}))[r]=t);return i},previous:function(e){return null!=e&&this._previousAttributes?this._previousAttributes[e]:null},previousAttributes:function(){return a.clone(this._previousAttributes)},fetch:function(e){e=e?a.clone(e):{},void 0===e.parse&&(e.parse=!0);var t=this,i=e.success;return e.success=function(n){return t.set(t.parse(n,e),e)?(i&&i(t,n,e),t.trigger("sync",t,n,e),void 0):!1},z(this,e),this.sync("read",this,e)},save:function(e,t,i){var n,r,o,s=this.attributes;if(null==e||"object"==typeof e?(n=e,i=t):(n={})[e]=t,!(!n||i&&i.wait||this.set(n,i)))return!1;if(i=a.extend({validate:!0},i),!this._validate(n,i))return!1;n&&i.wait&&(this.attributes=a.extend({},s,n)),void 0===i.parse&&(i.parse=!0);var l=this,h=i.success;return i.success=function(e){l.attributes=s;var t=l.parse(e,i);return i.wait&&(t=a.extend(n||{},t)),a.isObject(t)&&!l.set(t,i)?!1:(h&&h(l,e,i),l.trigger("sync",l,e,i),void 0)},z(this,i),r=this.isNew()?"create":i.patch?"patch":"update","patch"===r&&(i.attrs=n),o=this.sync(r,this,i),n&&i.wait&&(this.attributes=s),o},destroy:function(e){e=e?a.clone(e):{};var t=this,i=e.success,n=function(){t.trigger("destroy",t,t.collection,e)};if(e.success=function(r){(e.wait||t.isNew())&&n(),i&&i(t,r,e),t.isNew()||t.trigger("sync",t,r,e)},this.isNew())return e.success(),!1;z(this,e);var r=this.sync("delete",this,e);return e.wait||n(),r},url:function(){var e=a.result(this,"urlRoot")||a.result(this.collection,"url")||L();return this.isNew()?e:e+("/"===e.charAt(e.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(e){return e},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},isValid:function(e){return this._validate({},a.extend(e||{},{validate:!0}))},_validate:function(e,t){if(!t.validate||!this.validate)return!0;e=a.extend({},this.attributes,e);var i=this.validationError=this.validate(e,t)||null;return i?(this.trigger("invalid",this,i,a.extend(t||{},{validationError:i})),!1):!0}});var g=["keys","values","pairs","invert","pick","omit"];a.each(g,function(e){p.prototype[e]=function(){var t=o.call(arguments);return t.unshift(this.attributes),a[e].apply(a,t)}});var m=e.Collection=function(e,t){t||(t={}),t.url&&(this.url=t.url),t.model&&(this.model=t.model),void 0!==t.comparator&&(this.comparator=t.comparator),this._reset(),this.initialize.apply(this,arguments),e&&this.reset(e,a.extend({silent:!0},t))},v={add:!0,remove:!0,merge:!0},w={add:!0,merge:!1,remove:!1};a.extend(m.prototype,l,{model:p,initialize:function(){},toJSON:function(e){return this.map(function(t){return t.toJSON(e)})},sync:function(){return e.sync.apply(this,arguments)},add:function(e,t){return this.set(e,a.defaults(t||{},w))},remove:function(e,t){e=a.isArray(e)?e.slice():[e],t||(t={});var i,n,r,o;for(i=0,n=e.length;n>i;i++)o=this.get(e[i]),o&&(delete this._byId[o.id],delete this._byId[o.cid],r=this.indexOf(o),this.models.splice(r,1),this.length--,t.silent||(t.index=r,o.trigger("remove",o,this,t)),this._removeReference(o));return this},set:function(e,t){t=a.defaults(t||{},v),t.parse&&(e=this.parse(e,t)),a.isArray(e)||(e=e?[e]:[]);var i,n,o,l,h,d=t.at,u=this.comparator&&null==d&&t.sort!==!1,c=a.isString(this.comparator)?this.comparator:null,p=[],f=[],g={};for(i=0,n=e.length;n>i;i++)(o=this._prepareModel(e[i],t))&&((l=this.get(o))?(t.remove&&(g[l.cid]=!0),t.merge&&(l.set(o.attributes,t),u&&!h&&l.hasChanged(c)&&(h=!0))):t.add&&(p.push(o),o.on("all",this._onModelEvent,this),this._byId[o.cid]=o,null!=o.id&&(this._byId[o.id]=o)));if(t.remove){for(i=0,n=this.length;n>i;++i)g[(o=this.models[i]).cid]||f.push(o);f.length&&this.remove(f,t)}if(p.length&&(u&&(h=!0),this.length+=p.length,null!=d?s.apply(this.models,[d,0].concat(p)):r.apply(this.models,p)),h&&this.sort({silent:!0}),t.silent)return this;for(i=0,n=p.length;n>i;i++)(o=p[i]).trigger("add",o,this,t);return h&&this.trigger("sort",this,t),this},reset:function(e,t){t||(t={});for(var i=0,n=this.models.length;n>i;i++)this._removeReference(this.models[i]);return t.previousModels=this.models,this._reset(),this.add(e,a.extend({silent:!0},t)),t.silent||this.trigger("reset",this,t),this},push:function(e,t){return e=this._prepareModel(e,t),this.add(e,a.extend({at:this.length},t)),e},pop:function(e){var t=this.at(this.length-1);return this.remove(t,e),t},unshift:function(e,t){return e=this._prepareModel(e,t),this.add(e,a.extend({at:0},t)),e},shift:function(e){var t=this.at(0);return this.remove(t,e),t},slice:function(e,t){return this.models.slice(e,t)},get:function(e){return null==e?void 0:this._byId[null!=e.id?e.id:e.cid||e]},at:function(e){return this.models[e]},where:function(e,t){return a.isEmpty(e)?t?void 0:[]:this[t?"find":"filter"](function(t){for(var i in e)if(e[i]!==t.get(i))return!1;return!0})},findWhere:function(e){return this.where(e,!0)},sort:function(e){if(!this.comparator)throw Error("Cannot sort a set without a comparator");return e||(e={}),a.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(a.bind(this.comparator,this)),e.silent||this.trigger("sort",this,e),this},sortedIndex:function(e,t,i){t||(t=this.comparator);var n=a.isFunction(t)?t:function(e){return e.get(t)};return a.sortedIndex(this.models,e,n,i)},pluck:function(e){return a.invoke(this.models,"get",e)},fetch:function(e){e=e?a.clone(e):{},void 0===e.parse&&(e.parse=!0);var t=e.success,i=this;return e.success=function(n){var r=e.reset?"reset":"set";i[r](n,e),t&&t(i,n,e),i.trigger("sync",i,n,e)},z(this,e),this.sync("read",this,e)},create:function(e,t){if(t=t?a.clone(t):{},!(e=this._prepareModel(e,t)))return!1;t.wait||this.add(e,t);var i=this,n=t.success;return t.success=function(r){t.wait&&i.add(e,t),n&&n(e,r,t)},e.save(null,t),e},parse:function(e){return e},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(e,t){if(e instanceof p)return e.collection||(e.collection=this),e;t||(t={}),t.collection=this;var i=new this.model(e,t);return i._validate(e,t)?i:(this.trigger("invalid",this,e,t),!1)},_removeReference:function(e){this===e.collection&&delete e.collection,e.off("all",this._onModelEvent,this)},_onModelEvent:function(e,t,i,n){("add"!==e&&"remove"!==e||i===this)&&("destroy"===e&&this.remove(t,n),t&&e==="change:"+t.idAttribute&&(delete this._byId[t.previous(t.idAttribute)],null!=t.id&&(this._byId[t.id]=t)),this.trigger.apply(this,arguments))}});var b=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];a.each(b,function(e){m.prototype[e]=function(){var t=o.call(arguments);return t.unshift(this.models),a[e].apply(a,t)}});var y=["groupBy","countBy","sortBy"];a.each(y,function(e){m.prototype[e]=function(t,i){var n=a.isFunction(t)?t:function(e){return e.get(t)};return a[e](this.models,n,i)}});var k=e.View=function(e){this.cid=a.uniqueId("view"),this._configure(e||{}),this._ensureElement(),this.initialize.apply(this,arguments),this.delegateEvents()},x=/^(\S+)\s*(.*)$/,I=["model","collection","el","id","attributes","className","tagName","events"];a.extend(k.prototype,l,{tagName:"div",$:function(e){return this.$el.find(e)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.stopListening(),this},setElement:function(t,i){return this.$el&&this.undelegateEvents(),this.$el=t instanceof e.$?t:e.$(t),this.el=this.$el[0],i!==!1&&this.delegateEvents(),this},delegateEvents:function(e){if(!e&&!(e=a.result(this,"events")))return this;this.undelegateEvents();for(var t in e){var i=e[t];if(a.isFunction(i)||(i=this[e[t]]),i){var n=t.match(x),r=n[1],o=n[2];i=a.bind(i,this),r+=".delegateEvents"+this.cid,""===o?this.$el.on(r,i):this.$el.on(r,o,i)}}return this},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},_configure:function(e){this.options&&(e=a.extend({},a.result(this,"options"),e)),a.extend(this,a.pick(e,I)),this.options=e},_ensureElement:function(){if(this.el)this.setElement(a.result(this,"el"),!1);else{var t=a.extend({},a.result(this,"attributes"));this.id&&(t.id=a.result(this,"id")),this.className&&(t["class"]=a.result(this,"className"));var i=e.$("<"+a.result(this,"tagName")+">").attr(t);this.setElement(i,!1)}}}),e.sync=function(t,i,n){var r=_[t];a.defaults(n||(n={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var o={type:r,dataType:"json"};if(n.url||(o.url=a.result(i,"url")||L()),null!=n.data||!i||"create"!==t&&"update"!==t&&"patch"!==t||(o.contentType="application/json",o.data=JSON.stringify(n.attrs||i.toJSON(n))),n.emulateJSON&&(o.contentType="application/x-www-form-urlencoded",o.data=o.data?{model:o.data}:{}),n.emulateHTTP&&("PUT"===r||"DELETE"===r||"PATCH"===r)){o.type="POST",n.emulateJSON&&(o.data._method=r);var s=n.beforeSend;n.beforeSend=function(e){return e.setRequestHeader("X-HTTP-Method-Override",r),s?s.apply(this,arguments):void 0}}"GET"===o.type||n.emulateJSON||(o.processData=!1),"PATCH"!==o.type||!window.ActiveXObject||window.external&&window.external.msActiveXFilteringEnabled||(o.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var l=n.xhr=e.ajax(a.extend(o,n));return i.trigger("request",i,l,n),l};var _={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};e.ajax=function(){return e.$.ajax.apply(e.$,arguments)};var $=e.Router=function(e){e||(e={}),e.routes&&(this.routes=e.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},E=/\((.*?)\)/g,S=/(\(\?)?:\w+/g,C=/\*\w+/g,N=/[\-{}\[\]+?.,\\\^$|#\s]/g;a.extend($.prototype,l,{initialize:function(){},route:function(t,i,n){a.isRegExp(t)||(t=this._routeToRegExp(t)),a.isFunction(i)&&(n=i,i=""),n||(n=this[i]);var r=this;return e.history.route(t,function(o){var s=r._extractParameters(t,o);n&&n.apply(r,s),r.trigger.apply(r,["route:"+i].concat(s)),r.trigger("route",i,s),e.history.trigger("route",r,i,s)}),this},navigate:function(t,i){return e.history.navigate(t,i),this},_bindRoutes:function(){if(this.routes){this.routes=a.result(this,"routes");for(var e,t=a.keys(this.routes);null!=(e=t.pop());)this.route(e,this.routes[e])}},_routeToRegExp:function(e){return e=e.replace(N,"\\$&").replace(E,"(?:$1)?").replace(S,function(e,t){return t?e:"([^/]+)"}).replace(C,"(.*?)"),RegExp("^"+e+"$")},_extractParameters:function(e,t){var i=e.exec(t).slice(1);return a.map(i,function(e){return e?decodeURIComponent(e):null})}});var P=e.History=function(){this.handlers=[],a.bindAll(this,"checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history)},G=/^[#\/]|\s+$/g,O=/^\/+|\/+$/g,T=/msie [\w.]+/,A=/\/$/;P.started=!1,a.extend(P.prototype,l,{interval:50,getHash:function(e){var t=(e||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(e,t){if(null==e)if(this._hasPushState||!this._wantsHashChange||t){e=this.location.pathname;var i=this.root.replace(A,"");e.indexOf(i)||(e=e.substr(i.length))}else e=this.getHash();return e.replace(G,"")},start:function(t){if(P.started)throw Error("Backbone.history has already been started");P.started=!0,this.options=a.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var i=this.getFragment(),n=document.documentMode,r=T.exec(navigator.userAgent.toLowerCase())&&(!n||7>=n);this.root=("/"+this.root+"/").replace(O,"/"),r&&this._wantsHashChange&&(this.iframe=e.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(i)),this._hasPushState?e.$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!r?e.$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=i;var o=this.location,s=o.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!s?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&s&&o.hash&&(this.fragment=this.getHash().replace(G,""),this.history.replaceState({},document.title,this.root+this.fragment+o.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){e.$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),P.started=!1},route:function(e,t){this.handlers.unshift({route:e,callback:t})},checkUrl:function(){var e=this.getFragment();return e===this.fragment&&this.iframe&&(e=this.getFragment(this.getHash(this.iframe))),e===this.fragment?!1:(this.iframe&&this.navigate(e),this.loadUrl()||this.loadUrl(this.getHash()),void 0)},loadUrl:function(e){var t=this.fragment=this.getFragment(e),i=a.any(this.handlers,function(e){return e.route.test(t)?(e.callback(t),!0):void 0});return i},navigate:function(e,t){if(!P.started)return!1;if(t&&t!==!0||(t={trigger:t}),e=this.getFragment(e||""),this.fragment!==e){this.fragment=e;var i=this.root+e;if(this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,i);else{if(!this._wantsHashChange)return this.location.assign(i);this._updateHash(this.location,e,t.replace),this.iframe&&e!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,e,t.replace))}t.trigger&&this.loadUrl(e)}},_updateHash:function(e,t,i){if(i){var n=e.href.replace(/(javascript:|#).*$/,"");e.replace(n+"#"+t)}else e.hash="#"+t}}),e.history=new P;var M=function(e,t){var i,n=this;i=e&&a.has(e,"constructor")?e.constructor:function(){return n.apply(this,arguments)},a.extend(i,n,t);var r=function(){this.constructor=i};return r.prototype=n.prototype,i.prototype=new r,e&&a.extend(i.prototype,e),i.__super__=n.prototype,i};p.extend=m.extend=$.extend=k.extend=P.extend=M;var L=function(){throw Error('A "url" property or function must be specified')
},z=function(e,t){var i=t.error;t.error=function(n){i&&i(e,n,t),e.trigger("error",e,n,t)}}}.call(this),function(){function e(){return(0|65536*(1+Math.random())).toString(16).substring(1)}function t(){return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var i=this._,n=this.Backbone;n.LocalStorage=window.Store=function(e){this.name=e;var t=this.localStorage().getItem(this.name);this.records=t&&t.split(",")||[]},i.extend(n.LocalStorage.prototype,{save:function(){this.localStorage().setItem(this.name,this.records.join(","))},create:function(e){return e.id||(e.id=t(),e.set(e.idAttribute,e.id)),this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),this.records.push(""+e.id),this.save(),e},update:function(e){return this.localStorage().setItem(this.name+"-"+e.id,JSON.stringify(e)),i.include(this.records,""+e.id)||this.records.push(""+e.id),this.save(),e},find:function(e){return JSON.parse(this.localStorage().getItem(this.name+"-"+e.id))},findAll:function(){return i(this.records).chain().map(function(e){return JSON.parse(this.localStorage().getItem(this.name+"-"+e))},this).compact().value()},destroy:function(e){return this.localStorage().removeItem(this.name+"-"+e.id),this.records=i.reject(this.records,function(t){return t==""+e.id}),this.save(),e},localStorage:function(){return localStorage}}),n.LocalStorage.sync=window.Store.sync=n.localSync=function(e,t,i,n){var r=t.localStorage||t.collection.localStorage;"function"==typeof i&&(i={success:i,error:n});var o;switch(e){case"read":o=void 0!=t.id?r.find(t):r.findAll();break;case"create":o=r.create(t);break;case"update":o=r.update(t);break;case"delete":o=r.destroy(t)}o?i.success(o):i.error("Record not found")},n.ajaxSync=n.sync,n.getSyncMethod=function(e){return e.localStorage||e.collection&&e.collection.localStorage?n.localSync:n.ajaxSync},n.sync=function(e,t,i,r){return n.getSyncMethod(t).apply(this,[e,t,i,r])}}(),function(){function e(e,t,i){return e.addEventListener?e.addEventListener(t,i,!1):(e.attachEvent("on"+t,i),void 0)}function t(e){return"keypress"==e.type?String.fromCharCode(e.which):b[e.which]?b[e.which]:y[e.which]?y[e.which]:String.fromCharCode(e.which).toLowerCase()}function i(e){var t=e.target||e.srcElement,i=t.tagName;return(" "+t.className+" ").indexOf(" mousetrap ")>-1?!1:"INPUT"==i||"SELECT"==i||"TEXTAREA"==i||t.contentEditable&&"true"==t.contentEditable}function n(e,t){return e.sort().join(",")===t.sort().join(",")}function r(e){e=e||{};var t,i=!1;for(t in $)e[t]?i=!0:$[t]=0;i||(S=!1)}function o(e,t,i,r,o){var s,a,l=[],h=i.type;if(!I[e])return[];for("keyup"==h&&d(e)&&(t=[e]),s=0;I[e].length>s;++s)a=I[e][s],a.seq&&$[a.seq]!=a.level||h==a.action&&("keypress"==h&&!i.metaKey&&!i.ctrlKey||n(t,a.modifiers))&&(r&&a.combo==o&&I[e].splice(s,1),l.push(a));return l}function s(e){var t=[];return e.shiftKey&&t.push("shift"),e.altKey&&t.push("alt"),e.ctrlKey&&t.push("ctrl"),e.metaKey&&t.push("meta"),t}function a(e,t){e(t)===!1&&(t.preventDefault&&t.preventDefault(),t.stopPropagation&&t.stopPropagation(),t.returnValue=!1,t.cancelBubble=!0)}function l(e,t){if(!i(t)){var n,l=o(e,s(t),t),h={},u=!1;for(n=0;l.length>n;++n)l[n].seq?(u=!0,h[l[n].seq]=1,a(l[n].callback,t)):u||S||a(l[n].callback,t);t.type!=S||d(e)||r(h)}}function h(e){e.which="number"==typeof e.which?e.which:e.keyCode;var i=t(e);if(i)return"keyup"==e.type&&E==i?(E=!1,void 0):(l(i,e),void 0)}function d(e){return"shift"==e||"ctrl"==e||"alt"==e||"meta"==e}function u(){clearTimeout(w),w=setTimeout(r,1e3)}function c(){if(!v){v={};for(var e in b)e>95&&112>e||b.hasOwnProperty(e)&&(v[b[e]]=e)}return v}function p(e,t,i){return i||(i=c()[e]?"keydown":"keypress"),"keypress"==i&&t.length&&(i="keydown"),i}function f(e,i,n,o){$[e]=0,o||(o=p(i[0],[]));var s,l=function(){S=o,++$[e],u()},h=function(e){a(n,e),"keyup"!==o&&(E=t(e)),setTimeout(r,10)};for(s=0;i.length>s;++s)g(i[s],i.length-1>s?l:h,o,e,s)}function g(e,t,i,n,r){e=e.replace(/\s+/g," ");var s,a,l,h=e.split(" "),u=[];if(h.length>1)return f(e,h,t,i);for(l="+"===e?["+"]:e.split("+"),s=0;l.length>s;++s)a=l[s],x[a]&&(a=x[a]),i&&"keypress"!=i&&k[a]&&(a=k[a],u.push("shift")),d(a)&&u.push(a);i=p(a,u,i),I[a]||(I[a]=[]),o(a,u,{type:i},!n,e),I[a][n?"unshift":"push"]({callback:t,modifiers:u,action:i,seq:n,level:r,combo:e})}function m(e,t,i){for(var n=0;e.length>n;++n)g(e[n],t,i)}for(var v,w,b={8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"ins",46:"del",91:"meta",93:"meta",224:"meta"},y={106:"*",107:"+",109:"-",110:".",111:"/",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},k={"~":"`","!":"1","@":"2","#":"3",$:"4","%":"5","^":"6","&":"7","*":"8","(":"9",")":"0",_:"-","+":"=",":":";",'"':"'","<":",",">":".","?":"/","|":"\\"},x={option:"alt",command:"meta","return":"enter",escape:"esc"},I={},_={},$={},E=!1,S=!1,C=1;20>C;++C)b[111+C]="f"+C;for(C=0;9>=C;++C)b[C+96]=C;e(document,"keypress",h),e(document,"keydown",h),e(document,"keyup",h);var N={bind:function(e,t,i){return m(e instanceof Array?e:[e],t,i),_[e+":"+i]=t,this},unbind:function(e,t){return _[e+":"+t]&&(delete _[e+":"+t],this.bind(e,function(){},t)),this},trigger:function(e,t){return _[e+":"+t](),this},reset:function(){return I={},_={},this}};window.Mousetrap=N,"function"==typeof define&&define.amd&&define("mousetrap",function(){return N})}(),function(e,t,i){function n(e,t,i){for(var n=[],r=0;e.length>r;r++){var o=tinycolor(e[r]),s=.5>o.toHsl().l?"sp-thumb-el sp-thumb-dark":"sp-thumb-el sp-thumb-light";s+=tinycolor.equals(t,e[r])?" sp-thumb-active":"";var a=m?"background-color:"+o.toRgbString():"filter:"+o.toFilter();n.push('<span title="'+o.toRgbString()+'" data-color="'+o.toRgbString()+'" class="'+s+'"><span class="sp-thumb-inner" style="'+a+';" /></span>')}return"<div class='sp-cf "+i+"'>"+n.join("")+"</div>"}function r(){for(var e=0;f.length>e;e++)f[e]&&f[e].hide()}function o(e,i){var n=t.extend({},p,e);return n.callbacks={move:d(n.move,i),change:d(n.change,i),show:d(n.show,i),hide:d(n.hide,i),beforeShow:d(n.beforeShow,i)},n}function s(s,l){function d(){mt.toggleClass("sp-flat",D),mt.toggleClass("sp-input-disabled",!B.showInput),mt.toggleClass("sp-alpha-enabled",B.showAlpha),mt.toggleClass("sp-buttons-disabled",!B.showButtons||D),mt.toggleClass("sp-palette-disabled",!B.showPalette),mt.toggleClass("sp-palette-only",B.showPaletteOnly),mt.toggleClass("sp-initial-disabled",!B.showInitial),mt.addClass(B.className),z()}function p(){function i(e){return e.data&&e.data.ignore?(P(t(this).data("color")),T()):(P(t(this).data("color")),L(!0),T(),C()),!1}if(g&&mt.find("*:not(input)").attr("unselectable","on"),d(),Pt&&ft.after(Gt).hide(),D)ft.after(mt).hide();else{var n="parent"===B.appendTo?ft.parent():t(B.appendTo);1!==n.length&&(n=t("body")),n.append(mt)}if(q&&e.localStorage){try{var r=e.localStorage[q].split(",#");r.length>1&&(delete e.localStorage[q],t.each(r,function(e,t){b(t)}))}catch(o){}try{dt=e.localStorage[q].split(";")}catch(o){}}Ot.bind("click.spectrum touchstart.spectrum",function(e){gt||E(),e.stopPropagation(),t(e.target).is("input")||e.preventDefault()}),(ft.is(":disabled")||B.disabled===!0)&&V(),mt.click(h),_t.change($),_t.bind("paste",function(){setTimeout($,1)}),_t.keydown(function(e){13==e.keyCode&&$()}),St.text(B.cancelText),St.bind("click.spectrum",function(e){e.stopPropagation(),e.preventDefault(),C("cancel")}),Ct.text(B.chooseText),Ct.bind("click.spectrum",function(e){e.stopPropagation(),e.preventDefault(),O()&&(L(!0),C())}),u(xt,function(e,t,i){at=e/tt,i.shiftKey&&(at=Math.round(10*at)/10),T()}),u(bt,function(e,t){rt=parseFloat(t/Z),T()},I,_),u(vt,function(e,t){ot=parseFloat(e/W),st=parseFloat((K-t)/K),T()},I,_),At?(P(At),A(),zt=Lt||tinycolor(At).format,b(At)):A(),D&&S();var s=g?"mousedown.spectrum":"click.spectrum touchstart.spectrum";$t.delegate(".sp-thumb-el",s,i),Et.delegate(".sp-thumb-el:nth-child(1)",s,{ignore:!0},i)}function b(i){if(H){var n=tinycolor(i).toRgbString();if(-1===t.inArray(n,dt))for(dt.push(n);dt.length>ut;)dt.shift();if(q&&e.localStorage)try{e.localStorage[q]=dt.join(";")}catch(r){}}}function y(){var e,t=[],i=dt,n={};if(B.showPalette){for(var r=0;ht.length>r;r++)for(var o=0;ht[r].length>o;o++)e=tinycolor(ht[r][o]).toRgbString(),n[e]=!0;for(r=0;i.length>r;r++)e=tinycolor(i[r]).toRgbString(),n.hasOwnProperty(e)||(t.push(i[r]),n[e]=!0)}return t.reverse().slice(0,B.maxSelectionSize)}function k(){var e=G(),i=t.map(ht,function(t,i){return n(t,e,"sp-palette-row sp-palette-row-"+i)});dt&&i.push(n(y(),e,"sp-palette-row sp-palette-row-selection")),$t.html(i.join(""))}function x(){if(B.showInitial){var e=Mt,t=G();Et.html(n([e,t],t,"sp-palette-row-initial"))}}function I(){(0>=K||0>=W||0>=Z)&&z(),mt.addClass(ct)}function _(){mt.removeClass(ct)}function $(){var e=tinycolor(_t.val());e.ok?P(e):_t.addClass("sp-validation-error")}function E(){Y?C():S()}function S(){var n=t.Event("beforeShow.spectrum");return Y?(z(),i):(ft.trigger(n,[G()]),J.beforeShow(G())===!1||n.isDefaultPrevented()||(r(),Y=!0,t(pt).bind("click.spectrum",C),t(e).bind("resize.spectrum",X),Gt.addClass("sp-active"),mt.removeClass("sp-hidden"),B.showPalette&&k(),z(),A(),Mt=G(),x(),J.show(Mt),ft.trigger("show.spectrum",[Mt])),i)}function C(i){if((!i||"click"!=i.type||2!=i.button)&&Y&&!D){Y=!1,t(pt).unbind("click.spectrum",C),t(e).unbind("resize.spectrum",X),Gt.removeClass("sp-active"),mt.addClass("sp-hidden");var n=!tinycolor.equals(G(),Mt);n&&(Ft&&"cancel"!==i?L(!0):N()),J.hide(G()),ft.trigger("hide.spectrum",[G()])}}function N(){P(Mt,!0)}function P(e,t){if(!tinycolor.equals(e,G())){var i=tinycolor(e),n=i.toHsv();rt=n.h,ot=n.s,st=n.v,at=n.a,A(),i.ok&&!t&&(zt=Lt||i.format)}}function G(e){return e=e||{},tinycolor.fromRatio({h:rt,s:ot,v:st,a:Math.round(100*at)/100},{format:e.format||zt})}function O(){return!_t.hasClass("sp-validation-error")}function T(){A(),J.move(G()),ft.trigger("move.spectrum",[G()])}function A(){_t.removeClass("sp-validation-error"),M();var e=tinycolor.fromRatio({h:rt,s:1,v:1});vt.css("background-color",e.toHexString());var t=zt;1>at&&("hex"===t||"hex3"===t||"hex6"===t||"name"===t)&&(t="rgb");var i=G({format:t}),n=i.toHexString(),r=i.toRgbString();if(m||1===i.alpha?Tt.css("background-color",r):(Tt.css("background-color","transparent"),Tt.css("filter",i.toFilter())),B.showAlpha){var o=i.toRgb();o.a=0;var s=tinycolor(o).toRgbString(),a="linear-gradient(left, "+s+", "+n+")";g?kt.css("filter",tinycolor(s).toFilter({gradientType:1},n)):(kt.css("background","-webkit-"+a),kt.css("background","-moz-"+a),kt.css("background","-ms-"+a),kt.css("background",a))}B.showInput&&_t.val(i.toString(t)),B.showPalette&&k(),x()}function M(){var e=ot,t=st,i=e*W,n=K-t*K;i=Math.max(-Q,Math.min(W-Q,i-Q)),n=Math.max(-Q,Math.min(K-Q,n-Q)),wt.css({top:n,left:i});var r=at*tt;It.css({left:r-it/2});var o=rt*Z;yt.css({top:o-nt})}function L(e){var t=G();Nt&&ft.val(t.toString(zt)).change();var i=!tinycolor.equals(t,Mt);Mt=t,b(t),e&&i&&(J.change(t),ft.trigger("change.spectrum",[t]))}function z(){W=vt.width(),K=vt.height(),Q=wt.height(),et=bt.width(),Z=bt.height(),nt=yt.height(),tt=xt.width(),it=It.width(),D||(mt.css("position","absolute"),mt.offset(a(mt,Ot))),M()}function F(){ft.show(),Ot.unbind("click.spectrum touchstart.spectrum"),mt.remove(),Gt.remove(),f[Rt.id]=null}function R(e,n){return e===i?t.extend({},B):n===i?B[e]:(B[e]=n,d(),i)}function j(){gt=!1,ft.attr("disabled",!1),Ot.removeClass("sp-disabled")}function V(){C(),gt=!0,ft.attr("disabled",!0),Ot.addClass("sp-disabled")}var B=o(l,s),D=B.flat,H=B.showSelectionPalette,q=B.localStorageKey,U=B.theme,J=B.callbacks,X=c(z,10),Y=!1,W=0,K=0,Q=0,Z=0,et=0,tt=0,it=0,nt=0,rt=0,ot=0,st=0,at=1,lt=B.palette.slice(0),ht=t.isArray(lt[0])?lt:[lt],dt=B.selectionPalette.slice(0),ut=B.maxSelectionSize,ct="sp-dragging",pt=s.ownerDocument,ft=(pt.body,t(s)),gt=!1,mt=t(w,pt).addClass(U),vt=mt.find(".sp-color"),wt=mt.find(".sp-dragger"),bt=mt.find(".sp-hue"),yt=mt.find(".sp-slider"),kt=mt.find(".sp-alpha-inner"),xt=mt.find(".sp-alpha"),It=mt.find(".sp-alpha-handle"),_t=mt.find(".sp-input"),$t=mt.find(".sp-palette"),Et=mt.find(".sp-initial"),St=mt.find(".sp-cancel"),Ct=mt.find(".sp-choose"),Nt=ft.is("input"),Pt=Nt&&!D,Gt=Pt?t(v).addClass(U).addClass(B.className):t([]),Ot=Pt?Gt:ft,Tt=Gt.find(".sp-preview-inner"),At=B.color||Nt&&ft.val(),Mt=!1,Lt=B.preferredFormat,zt=Lt,Ft=!B.showButtons||B.clickoutFiresChange;p();var Rt={show:S,hide:C,toggle:E,reflow:z,option:R,enable:j,disable:V,set:function(e){P(e),L()},get:G,destroy:F,container:mt};return Rt.id=f.push(Rt)-1,Rt}function a(e,i){var n=0,r=e.outerWidth(),o=e.outerHeight(),s=i.outerHeight(),a=e[0].ownerDocument,l=a.documentElement,h=l.clientWidth+t(a).scrollLeft(),d=l.clientHeight+t(a).scrollTop(),u=i.offset();return u.top+=s,u.left-=Math.min(u.left,u.left+r>h&&h>r?Math.abs(u.left+r-h):0),u.top-=Math.min(u.top,u.top+o>d&&d>o?Math.abs(o+s-n):n),u}function l(){}function h(e){e.stopPropagation()}function d(e,t){var i=Array.prototype.slice,n=i.call(arguments,2);return function(){return e.apply(t,n.concat(i.call(arguments)))}}function u(i,n,r,o){function s(e){e.stopPropagation&&e.stopPropagation(),e.preventDefault&&e.preventDefault(),e.returnValue=!1}function a(e){if(u){if(g&&9>document.documentMode&&!e.button)return h();var t=e.originalEvent.touches,r=t?t[0].pageX:e.pageX,o=t?t[0].pageY:e.pageY,a=Math.max(0,Math.min(r-c.left,f)),l=Math.max(0,Math.min(o-c.top,p));m&&s(e),n.apply(i,[a,l,e])}}function l(e){var n=e.which?3==e.which:2==e.button;e.originalEvent.touches,n||u||r.apply(i,arguments)!==!1&&(u=!0,p=t(i).height(),f=t(i).width(),c=t(i).offset(),t(d).bind(v),t(d.body).addClass("sp-dragging"),m||a(e),s(e))}function h(){u&&(t(d).unbind(v),t(d.body).removeClass("sp-dragging"),o.apply(i,arguments)),u=!1}n=n||function(){},r=r||function(){},o=o||function(){};var d=i.ownerDocument||document,u=!1,c={},p=0,f=0,m="ontouchstart"in e,v={};v.selectstart=s,v.dragstart=s,v[m?"touchmove":"mousemove"]=a,v[m?"touchend":"mouseup"]=h,t(i).bind(m?"touchstart":"mousedown",l)}function c(e,t,i){var n;return function(){var r=this,o=arguments,s=function(){n=null,e.apply(r,o)};i&&clearTimeout(n),(i||!n)&&(n=setTimeout(s,t))}}var p={beforeShow:l,move:l,change:l,show:l,hide:l,color:!1,flat:!1,showInput:!1,showButtons:!0,clickoutFiresChange:!1,showInitial:!1,showPalette:!1,showPaletteOnly:!1,showSelectionPalette:!0,localStorageKey:!1,appendTo:"body",maxSelectionSize:7,cancelText:"cancel",chooseText:"choose",preferredFormat:!1,className:"",showAlpha:!1,theme:"sp-light",palette:["fff","000"],selectionPalette:[],disabled:!1},f=[],g=!!/msie/i.exec(e.navigator.userAgent),m=function(){function e(e,t){return!!~(""+e).indexOf(t)}var t=document.createElement("div"),i=t.style;return i.cssText="background-color:rgba(0,0,0,.5)",e(i.backgroundColor,"rgba")||e(i.backgroundColor,"hsla")}(),v=["<div class='sp-replacer'>","<div class='sp-preview'><div class='sp-preview-inner'></div></div>","<div class='sp-dd'>&#9660;</div>","</div>"].join(""),w=function(){var e="";if(g)for(var t=1;6>=t;t++)e+="<div class='sp-"+t+"'></div>";return["<div class='sp-container sp-hidden'>","<div class='sp-palette-container'>","<div class='sp-palette sp-thumb sp-cf'></div>","</div>","<div class='sp-picker-container'>","<div class='sp-top sp-cf'>","<div class='sp-fill'></div>","<div class='sp-top-inner'>","<div class='sp-color'>","<div class='sp-sat'>","<div class='sp-val'>","<div class='sp-dragger'></div>","</div>","</div>","</div>","<div class='sp-hue'>","<div class='sp-slider'></div>",e,"</div>","</div>","<div class='sp-alpha'><div class='sp-alpha-inner'><div class='sp-alpha-handle'></div></div></div>","</div>","<div class='sp-input-container sp-cf'>","<input class='sp-input' type='text' spellcheck='false'  />","</div>","<div class='sp-initial sp-thumb sp-cf'></div>","<div class='sp-button-container sp-cf'>","<a class='sp-cancel' href='#'></a>","<button class='sp-choose'></button>","</div>","</div>","</div>"].join("")}(),b="spectrum.id";t.fn.spectrum=function(e){if("string"==typeof e){var i=this,n=Array.prototype.slice.call(arguments,1);return this.each(function(){var r=f[t(this).data(b)];if(r){var o=r[e];if(!o)throw Error("Spectrum: no such method: '"+e+"'");"get"==e?i=r.get():"container"==e?i=r.container:"option"==e?i=r.option.apply(r,n):"destroy"==e?(r.destroy(),t(this).removeData(b)):o.apply(r,n)}}),i}return this.spectrum("destroy").each(function(){var i=s(this,e);t(this).data(b,i.id)})},t.fn.spectrum.load=!0,t.fn.spectrum.loadOpts={},t.fn.spectrum.draggable=u,t.fn.spectrum.defaults=p,t.spectrum={},t.spectrum.localization={},t.spectrum.palettes={},t.fn.spectrum.processNativeColorInputs=function(){var e=t("<input type='color' value='!' />")[0],i="color"===e.type&&"!"!=e.value;i||t("input[type=color]").spectrum({preferredFormat:"hex6"})},function(e){function t(e,n){if(e=e?e:"",n=n||{},"object"==typeof e&&e.hasOwnProperty("_tc_id"))return e;var o=i(e),a=o.r,h=o.g,u=o.b,c=o.a,p=x(100*c)/100,f=n.format||o.format;return 1>a&&(a=x(a)),1>h&&(h=x(h)),1>u&&(u=x(u)),{ok:o.ok,format:f,_tc_id:y++,alpha:c,toHsv:function(){var e=s(a,h,u);return{h:360*e.h,s:e.s,v:e.v,a:c}},toHsvString:function(){var e=s(a,h,u),t=x(360*e.h),i=x(100*e.s),n=x(100*e.v);return 1==c?"hsv("+t+", "+i+"%, "+n+"%)":"hsva("+t+", "+i+"%, "+n+"%, "+p+")"},toHsl:function(){var e=r(a,h,u);return{h:360*e.h,s:e.s,l:e.l,a:c}},toHslString:function(){var e=r(a,h,u),t=x(360*e.h),i=x(100*e.s),n=x(100*e.l);return 1==c?"hsl("+t+", "+i+"%, "+n+"%)":"hsla("+t+", "+i+"%, "+n+"%, "+p+")"},toHex:function(e){return l(a,h,u,e)},toHexString:function(e){return"#"+l(a,h,u,e)},toRgb:function(){return{r:x(a),g:x(h),b:x(u),a:c}},toRgbString:function(){return 1==c?"rgb("+x(a)+", "+x(h)+", "+x(u)+")":"rgba("+x(a)+", "+x(h)+", "+x(u)+", "+p+")"},toPercentageRgb:function(){return{r:x(100*d(a,255))+"%",g:x(100*d(h,255))+"%",b:x(100*d(u,255))+"%",a:c}},toPercentageRgbString:function(){return 1==c?"rgb("+x(100*d(a,255))+"%, "+x(100*d(h,255))+"%, "+x(100*d(u,255))+"%)":"rgba("+x(100*d(a,255))+"%, "+x(100*d(h,255))+"%, "+x(100*d(u,255))+"%, "+p+")"},toName:function(){return S[l(a,h,u,!0)]||!1},toFilter:function(e){var i=l(a,h,u),r=i,o=Math.round(255*parseFloat(c)).toString(16),s=o,d=n&&n.gradientType?"GradientType = 1, ":"";if(e){var p=t(e);r=p.toHex(),s=Math.round(255*parseFloat(p.alpha)).toString(16)}return"progid:DXImageTransform.Microsoft.gradient("+d+"startColorstr=#"+g(o)+i+",endColorstr=#"+g(s)+r+")"},toString:function(e){e=e||this.format;var t=!1;return"rgb"===e&&(t=this.toRgbString()),"prgb"===e&&(t=this.toPercentageRgbString()),("hex"===e||"hex6"===e)&&(t=this.toHexString()),"hex3"===e&&(t=this.toHexString(!0)),"name"===e&&(t=this.toName()),"hsl"===e&&(t=this.toHslString()),"hsv"===e&&(t=this.toHsvString()),t||this.toHexString()}}}function i(e){var t={r:0,g:0,b:0},i=1,r=!1,s=!1;return"string"==typeof e&&(e=v(e)),"object"==typeof e&&(e.hasOwnProperty("r")&&e.hasOwnProperty("g")&&e.hasOwnProperty("b")?(t=n(e.r,e.g,e.b),r=!0,s="%"===(e.r+"").substr(-1)?"prgb":"rgb"):e.hasOwnProperty("h")&&e.hasOwnProperty("s")&&e.hasOwnProperty("v")?(e.s=m(e.s),e.v=m(e.v),t=a(e.h,e.s,e.v),r=!0,s="hsv"):e.hasOwnProperty("h")&&e.hasOwnProperty("s")&&e.hasOwnProperty("l")&&(e.s=m(e.s),e.l=m(e.l),t=o(e.h,e.s,e.l),r=!0,s="hsl"),e.hasOwnProperty("a")&&(i=e.a)),i=parseFloat(i),(isNaN(i)||0>i||i>1)&&(i=1),{ok:r,format:e.format||s,r:I(255,_(t.r,0)),g:I(255,_(t.g,0)),b:I(255,_(t.b,0)),a:i}}function n(e,t,i){return{r:255*d(e,255),g:255*d(t,255),b:255*d(i,255)}}function r(e,t,i){e=d(e,255),t=d(t,255),i=d(i,255);var n,r,o=_(e,t,i),s=I(e,t,i),a=(o+s)/2;if(o==s)n=r=0;else{var l=o-s;switch(r=a>.5?l/(2-o-s):l/(o+s),o){case e:n=(t-i)/l+(i>t?6:0);break;case t:n=(i-e)/l+2;break;case i:n=(e-t)/l+4}n/=6}return{h:n,s:r,l:a}}function o(e,t,i){function n(e,t,i){return 0>i&&(i+=1),i>1&&(i-=1),1/6>i?e+6*(t-e)*i:.5>i?t:2/3>i?e+6*(t-e)*(2/3-i):e}var r,o,s;if(e=d(e,360),t=d(t,100),i=d(i,100),0===t)r=o=s=i;else{var a=.5>i?i*(1+t):i+t-i*t,l=2*i-a;r=n(l,a,e+1/3),o=n(l,a,e),s=n(l,a,e-1/3)}return{r:255*r,g:255*o,b:255*s}}function s(e,t,i){e=d(e,255),t=d(t,255),i=d(i,255);var n,r,o=_(e,t,i),s=I(e,t,i),a=o,l=o-s;if(r=0===o?0:l/o,o==s)n=0;else{switch(o){case e:n=(t-i)/l+(i>t?6:0);break;case t:n=(i-e)/l+2;break;case i:n=(e-t)/l+4}n/=6}return{h:n,s:r,v:a}}function a(e,t,i){e=6*d(e,360),t=d(t,100),i=d(i,100);var n=k.floor(e),r=e-n,o=i*(1-t),s=i*(1-r*t),a=i*(1-(1-r)*t),l=n%6,h=[i,s,o,o,a,i][l],u=[a,i,i,s,o,o][l],c=[o,o,a,i,i,s][l];return{r:255*h,g:255*u,b:255*c}}function l(e,t,i,n){var r=[g(x(e).toString(16)),g(x(t).toString(16)),g(x(i).toString(16))];return n&&r[0].charAt(0)==r[0].charAt(1)&&r[1].charAt(0)==r[1].charAt(1)&&r[2].charAt(0)==r[2].charAt(1)?r[0].charAt(0)+r[1].charAt(0)+r[2].charAt(0):r.join("")}function h(e){var t={};for(var i in e)e.hasOwnProperty(i)&&(t[e[i]]=i);return t}function d(e,t){p(e)&&(e="100%");var i=f(e);return e=I(t,_(0,parseFloat(e))),i&&(e=parseInt(e*t,10)/100),1e-6>k.abs(e-t)?1:e%t/parseFloat(t)}function u(e){return I(1,_(0,e))}function c(e){return parseInt(e,16)}function p(e){return"string"==typeof e&&-1!=e.indexOf(".")&&1===parseFloat(e)}function f(e){return"string"==typeof e&&-1!=e.indexOf("%")}function g(e){return 1==e.length?"0"+e:""+e}function m(e){return 1>=e&&(e=100*e+"%"),e}function v(e){e=e.replace(w,"").replace(b,"").toLowerCase();var t=!1;if(E[e])e=E[e],t=!0;else if("transparent"==e)return{r:0,g:0,b:0,a:0};var i;return(i=C.rgb.exec(e))?{r:i[1],g:i[2],b:i[3]}:(i=C.rgba.exec(e))?{r:i[1],g:i[2],b:i[3],a:i[4]}:(i=C.hsl.exec(e))?{h:i[1],s:i[2],l:i[3]}:(i=C.hsla.exec(e))?{h:i[1],s:i[2],l:i[3],a:i[4]}:(i=C.hsv.exec(e))?{h:i[1],s:i[2],v:i[3]}:(i=C.hex6.exec(e))?{r:c(i[1]),g:c(i[2]),b:c(i[3]),format:t?"name":"hex"}:(i=C.hex3.exec(e))?{r:c(i[1]+""+i[1]),g:c(i[2]+""+i[2]),b:c(i[3]+""+i[3]),format:t?"name":"hex"}:!1}var w=/^[\s,#]+/,b=/\s+$/,y=0,k=Math,x=k.round,I=k.min,_=k.max,$=k.random;t.fromRatio=function(e,i){if("object"==typeof e){var n={};for(var r in e)e.hasOwnProperty(r)&&(n[r]="a"===r?e[r]:m(e[r]));e=n}return t(e,i)},t.equals=function(e,i){return e&&i?t(e).toRgbString()==t(i).toRgbString():!1},t.random=function(){return t.fromRatio({r:$(),g:$(),b:$()})},t.desaturate=function(e,i){var n=t(e).toHsl();return n.s-=(i||10)/100,n.s=u(n.s),t(n)},t.saturate=function(e,i){var n=t(e).toHsl();return n.s+=(i||10)/100,n.s=u(n.s),t(n)},t.greyscale=function(e){return t.desaturate(e,100)},t.lighten=function(e,i){var n=t(e).toHsl();return n.l+=(i||10)/100,n.l=u(n.l),t(n)},t.darken=function(e,i){var n=t(e).toHsl();return n.l-=(i||10)/100,n.l=u(n.l),t(n)},t.complement=function(e){var i=t(e).toHsl();return i.h=(i.h+180)%360,t(i)},t.triad=function(e){var i=t(e).toHsl(),n=i.h;return[t(e),t({h:(n+120)%360,s:i.s,l:i.l}),t({h:(n+240)%360,s:i.s,l:i.l})]},t.tetrad=function(e){var i=t(e).toHsl(),n=i.h;return[t(e),t({h:(n+90)%360,s:i.s,l:i.l}),t({h:(n+180)%360,s:i.s,l:i.l}),t({h:(n+270)%360,s:i.s,l:i.l})]},t.splitcomplement=function(e){var i=t(e).toHsl(),n=i.h;return[t(e),t({h:(n+72)%360,s:i.s,l:i.l}),t({h:(n+216)%360,s:i.s,l:i.l})]},t.analogous=function(e,i,n){i=i||6,n=n||30;var r=t(e).toHsl(),o=360/n,s=[t(e)];for(r.h=(r.h-(o*i>>1)+720)%360;--i;)r.h=(r.h+o)%360,s.push(t(r));return s},t.monochromatic=function(e,i){i=i||6;for(var n=t(e).toHsv(),r=n.h,o=n.s,s=n.v,a=[],l=1/i;i--;)a.push(t({h:r,s:o,v:s})),s=(s+l)%1;return a},t.readability=function(e,i){var n=t(e).toRgb(),r=t(i).toRgb(),o=(299*n.r+587*n.g+114*n.b)/1e3,s=(299*r.r+587*r.g+114*r.b)/1e3,a=Math.max(n.r,r.r)-Math.min(n.r,r.r)+Math.max(n.g,r.g)-Math.min(n.g,r.g)+Math.max(n.b,r.b)-Math.min(n.b,r.b);return{brightness:Math.abs(o-s),color:a}},t.readable=function(e,i){var n=t.readability(e,i);return n.brightness>125&&n.color>500},t.mostReadable=function(e,i){for(var n=null,r=0,o=!1,s=0;i.length>s;s++){var a=t.readability(e,i[s]),l=a.brightness>125&&a.color>500,h=3*(a.brightness/125)+a.color/500;(l&&!o||l&&o&&h>r||!l&&!o&&h>r)&&(o=l,r=h,n=t(i[s]))}return n};var E=t.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"},S=t.hexNames=h(E),C=function(){var e="[-\\+]?\\d+%?",t="[-\\+]?\\d*\\.\\d+%?",i="(?:"+t+")|(?:"+e+")",n="[\\s|\\(]+("+i+")[,|\\s]+("+i+")[,|\\s]+("+i+")\\s*\\)?",r="[\\s|\\(]+("+i+")[,|\\s]+("+i+")[,|\\s]+("+i+")[,|\\s]+("+i+")\\s*\\)?";return{rgb:RegExp("rgb"+n),rgba:RegExp("rgba"+r),hsl:RegExp("hsl"+n),hsla:RegExp("hsla"+r),hsv:RegExp("hsv"+n),hex3:/^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/}}();e.tinycolor=t}(this),t(function(){t.fn.spectrum.load&&t.fn.spectrum.processNativeColorInputs()})}(window,jQuery),function(e){function t(e,t){if(!(e.originalEvent.touches.length>1)){e.preventDefault();var i=e.originalEvent.changedTouches[0],n=document.createEvent("MouseEvents");n.initMouseEvent(t,!0,!0,window,1,i.screenX,i.screenY,i.clientX,i.clientY,!1,!1,!1,!1,0,null),e.target.dispatchEvent(n)}}if(e.support.touch="ontouchend"in document,e.support.touch){var i,n=e.ui.mouse.prototype,r=n._mouseInit;n._touchStart=function(e){var n=this;!i&&n._mouseCapture(e.originalEvent.changedTouches[0])&&(i=!0,n._touchMoved=!1,t(e,"mouseover"),t(e,"mousemove"),t(e,"mousedown"))},n._touchMove=function(e){i&&(this._touchMoved=!0,t(e,"mousemove"))},n._touchEnd=function(e){i&&(t(e,"mouseup"),t(e,"mouseout"),this._touchMoved||t(e,"click"),i=!1)},n._mouseInit=function(){var t=this;t.element.bind("touchstart",e.proxy(t,"_touchStart")).bind("touchmove",e.proxy(t,"_touchMove")).bind("touchend",e.proxy(t,"_touchEnd")),r.call(t)}}}(jQuery),Array.indexOf||(Array.prototype.indexOf=function(e,t){for(var i=t||0;this.length>i;i++)if(this[i]===e)return i;return-1});var Parser=function(e){function t(e){function t(){}return t.prototype=e,new t}function i(e,t,i,n){this.type_=e,this.index_=t||0,this.prio_=i||0,this.number_=void 0!==n&&null!==n?n:0,this.toString=function(){switch(this.type_){case v:return this.number_;case w:case b:case y:return this.index_;case k:return"CALL";default:return"Invalid Token"}}}function n(e,t,i,n){this.tokens=e,this.ops1=t,this.ops2=i,this.functions=n}function r(e){return"string"==typeof e?(x.lastIndex=0,x.test(e)?"'"+e.replace(x,function(e){var t=I[e];return"string"==typeof t?t:"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})+"'":"'"+e+"'"):e}function o(e,t){return Number(e)+Number(t)}function s(e,t){return e-t}function a(e,t){return e*t}function l(e,t){return e/t}function h(e,t){return e%t}function d(e,t){return""+e+t}function u(e){return-e}function c(e){return Math.random()*(e||1)}function p(e){e=Math.floor(e);for(var t=e;e>1;)t*=--e;return t}function f(e,t){return Math.sqrt(e*e+t*t)}function g(e,t){return"[object Array]"!=Object.prototype.toString.call(e)?[e,t]:(e=e.slice(),e.push(t),e)}function m(){this.success=!1,this.errormsg="",this.expression="",this.pos=0,this.tokennumber=0,this.tokenprio=0,this.tokenindex=0,this.tmpprio=0,this.ops1={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sqrt:Math.sqrt,log:Math.log,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,"-":u,exp:Math.exp},this.ops2={"+":o,"-":s,"*":a,"/":l,"%":h,"^":Math.pow,",":g,"||":d},this.functions={random:c,fac:p,min:Math.min,max:Math.max,pyt:f,pow:Math.pow,atan2:Math.atan2},this.consts={E:Math.E,PI:Math.PI}}var v=0,w=1,b=2,y=3,k=4,x=/[\\\'\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,I={"\b":"\\b","	":"\\t","\n":"\\n","\f":"\\f","\r":"\\r","'":"\\'","\\":"\\\\"};n.prototype={simplify:function(e){e=e||{};var r,o,s,a,l=[],h=[],d=this.tokens.length,u=0;for(u=0;d>u;u++){a=this.tokens[u];var c=a.type_;if(c===v)l.push(a);else if(c===y&&a.index_ in e)a=new i(v,0,0,e[a.index_]),l.push(a);else if(c===b&&l.length>1)o=l.pop(),r=l.pop(),s=this.ops2[a.index_],a=new i(v,0,0,s(r.number_,o.number_)),l.push(a);else if(c===w&&l.length>0)r=l.pop(),s=this.ops1[a.index_],a=new i(v,0,0,s(r.number_)),l.push(a);else{for(;l.length>0;)h.push(l.shift());h.push(a)}}for(;l.length>0;)h.push(l.shift());return new n(h,t(this.ops1),t(this.ops2),t(this.functions))},substitute:function(e,r){r instanceof n||(r=(new m).parse(r+""));var o,s=[],a=this.tokens.length,l=0;for(l=0;a>l;l++){o=this.tokens[l];var h=o.type_;if(h===y&&o.index_===e)for(var d=0;r.tokens.length>d;d++){var u=r.tokens[d],c=new i(u.type_,u.index_,u.prio_,u.number_);s.push(c)}else s.push(o)}var p=new n(s,t(this.ops1),t(this.ops2),t(this.functions));return p},evaluate:function(e){e=e||{};var t,i,n,r,o=[],s=this.tokens.length,a=0;for(a=0;s>a;a++){r=this.tokens[a];var l=r.type_;if(l===v)o.push(r.number_);else if(l===b)i=o.pop(),t=o.pop(),n=this.ops2[r.index_],o.push(n(t,i));else if(l===y)if(r.index_ in e)o.push(e[r.index_]);else{if(!(r.index_ in this.functions))throw Error("undefined variable: "+r.index_);o.push(this.functions[r.index_])}else if(l===w)t=o.pop(),n=this.ops1[r.index_],o.push(n(t));else{if(l!==k)throw Error("invalid Expression");if(t=o.pop(),n=o.pop(),!n.apply||!n.call)throw Error(n+" is not a function");"[object Array]"==Object.prototype.toString.call(t)?o.push(n.apply(void 0,t)):o.push(n.call(void 0,t))}}if(o.length>1)throw Error("invalid Expression (parity)");return o[0]},toString:function(e){var t,i,n,o,s=[],a=this.tokens.length,l=0;for(l=0;a>l;l++){o=this.tokens[l];var h=o.type_;if(h===v)s.push(r(o.number_));else if(h===b)i=s.pop(),t=s.pop(),n=o.index_,e&&"^"==n?s.push("Math.pow("+t+","+i+")"):s.push("("+t+n+i+")");
else if(h===y)s.push(o.index_);else if(h===w)t=s.pop(),n=o.index_,"-"===n?s.push("("+n+t+")"):s.push(n+"("+t+")");else{if(h!==k)throw Error("invalid Expression");t=s.pop(),n=s.pop(),s.push(n+"("+t+")")}}if(s.length>1)throw Error("invalid Expression (parity)");return s[0]},variables:function(){for(var e=this.tokens.length,t=[],i=0;e>i;i++){var n=this.tokens[i];n.type_===y&&-1==t.indexOf(n.index_)&&t.push(n.index_)}return t},toJSFunction:function(e,t){var i=Function(e,"with(Parser.values) { return "+this.simplify(t).toString(!0)+"; }");return i}},m.parse=function(e){return(new m).parse(e)},m.evaluate=function(e,t){return m.parse(e).evaluate(t)},m.Expression=n,m.values={sin:Math.sin,cos:Math.cos,tan:Math.tan,asin:Math.asin,acos:Math.acos,atan:Math.atan,sqrt:Math.sqrt,log:Math.log,abs:Math.abs,ceil:Math.ceil,floor:Math.floor,round:Math.round,random:c,fac:p,exp:Math.exp,min:Math.min,max:Math.max,pyt:f,pow:Math.pow,atan2:Math.atan2,E:Math.E,PI:Math.PI};var _=1,$=2,E=4,S=8,C=16,N=32,P=64,G=128,O=256;return m.prototype={parse:function(e){this.errormsg="",this.success=!0;var r=[],o=[];this.tmpprio=0;var s=_|S|E|P,a=0;for(this.expression=e,this.pos=0;this.pos<this.expression.length;)if(this.isOperator())this.isSign()&&s&P?(this.isNegativeSign()&&(this.tokenprio=2,this.tokenindex="-",a++,this.addfunc(o,r,w)),s=_|S|E|P):this.isComment()||(0===(s&$)&&this.error_parsing(this.pos,"unexpected operator"),a+=2,this.addfunc(o,r,b),s=_|S|E|P);else if(this.isNumber()){0===(s&_)&&this.error_parsing(this.pos,"unexpected number");var l=new i(v,0,0,this.tokennumber);o.push(l),s=$|C|N}else if(this.isString()){0===(s&_)&&this.error_parsing(this.pos,"unexpected string");var l=new i(v,0,0,this.tokennumber);o.push(l),s=$|C|N}else if(this.isLeftParenth())0===(s&S)&&this.error_parsing(this.pos,'unexpected "("'),s&G&&(a+=2,this.tokenprio=-2,this.tokenindex=-1,this.addfunc(o,r,k)),s=_|S|E|P|O;else if(this.isRightParenth()){if(s&O){var l=new i(v,0,0,[]);o.push(l)}else 0===(s&C)&&this.error_parsing(this.pos,'unexpected ")"');s=$|C|N|S|G}else if(this.isComma())0===(s&N)&&this.error_parsing(this.pos,'unexpected ","'),this.addfunc(o,r,b),a+=2,s=_|S|E|P;else if(this.isConst()){0===(s&_)&&this.error_parsing(this.pos,"unexpected constant");var h=new i(v,0,0,this.tokennumber);o.push(h),s=$|C|N}else if(this.isOp2())0===(s&E)&&this.error_parsing(this.pos,"unexpected function"),this.addfunc(o,r,b),a+=2,s=S;else if(this.isOp1())0===(s&E)&&this.error_parsing(this.pos,"unexpected function"),this.addfunc(o,r,w),a++,s=S;else if(this.isVar()){0===(s&_)&&this.error_parsing(this.pos,"unexpected variable");var d=new i(y,this.tokenindex,0,0);o.push(d),s=$|C|N|S|G}else this.isWhite()||(""===this.errormsg?this.error_parsing(this.pos,"unknown character"):this.error_parsing(this.pos,this.errormsg));for((0>this.tmpprio||this.tmpprio>=10)&&this.error_parsing(this.pos,'unmatched "()"');r.length>0;){var u=r.pop();o.push(u)}return a+1!==o.length&&this.error_parsing(this.pos,"parity"),new n(o,t(this.ops1),t(this.ops2),t(this.functions))},evaluate:function(e,t){return this.parse(e).evaluate(t)},error_parsing:function(e,t){throw this.success=!1,this.errormsg="parse error [column "+e+"]: "+t,Error(this.errormsg)},addfunc:function(e,t,n){for(var r=new i(n,this.tokenindex,this.tokenprio+this.tmpprio,0);t.length>0&&r.prio_<=t[t.length-1].prio_;)e.push(t.pop());t.push(r)},isNumber:function(){for(var e=!1,t="";this.pos<this.expression.length;){var i=this.expression.charCodeAt(this.pos);if(!(i>=48&&57>=i||46===i))break;t+=this.expression.charAt(this.pos),this.pos++,this.tokennumber=parseFloat(t),e=!0}return e},unescape:function(e,t){for(var i=[],n=!1,r=0;e.length>r;r++){var o=e.charAt(r);if(n){switch(o){case"'":i.push("'");break;case"\\":i.push("\\");break;case"/":i.push("/");break;case"b":i.push("\b");break;case"f":i.push("\f");break;case"n":i.push("\n");break;case"r":i.push("\r");break;case"t":i.push("	");break;case"u":var s=parseInt(e.substring(r+1,r+5),16);i.push(String.fromCharCode(s)),r+=4;break;default:throw this.error_parsing(t+r,"Illegal escape sequence: '\\"+o+"'")}n=!1}else"\\"==o?n=!0:i.push(o)}return i.join("")},isString:function(){var e=!1,t="",i=this.pos;if(this.pos<this.expression.length&&"'"==this.expression.charAt(this.pos))for(this.pos++;this.pos<this.expression.length;){var n=this.expression.charAt(this.pos);if("'"==n&&"\\"!=t.slice(-1)){this.pos++,this.tokennumber=this.unescape(t,i),e=!0;break}t+=this.expression.charAt(this.pos),this.pos++}return e},isConst:function(){var e;for(var t in this.consts){var i=t.length;if(e=this.expression.substr(this.pos,i),t===e)return this.tokennumber=this.consts[t],this.pos+=i,!0}return!1},isOperator:function(){var e=this.expression.charCodeAt(this.pos);if(43===e)this.tokenprio=0,this.tokenindex="+";else if(45===e)this.tokenprio=0,this.tokenindex="-";else if(124===e){if(124!==this.expression.charCodeAt(this.pos+1))return!1;this.pos++,this.tokenprio=0,this.tokenindex="||"}else if(42===e)this.tokenprio=1,this.tokenindex="*";else if(47===e)this.tokenprio=2,this.tokenindex="/";else if(37===e)this.tokenprio=2,this.tokenindex="%";else{if(94!==e)return!1;this.tokenprio=3,this.tokenindex="^"}return this.pos++,!0},isSign:function(){var e=this.expression.charCodeAt(this.pos-1);return 45===e||43===e?!0:!1},isPositiveSign:function(){var e=this.expression.charCodeAt(this.pos-1);return 43===e?!0:!1},isNegativeSign:function(){var e=this.expression.charCodeAt(this.pos-1);return 45===e?!0:!1},isLeftParenth:function(){var e=this.expression.charCodeAt(this.pos);return 40===e?(this.pos++,this.tmpprio+=10,!0):!1},isRightParenth:function(){var e=this.expression.charCodeAt(this.pos);return 41===e?(this.pos++,this.tmpprio-=10,!0):!1},isComma:function(){var e=this.expression.charCodeAt(this.pos);return 44===e?(this.pos++,this.tokenprio=-1,this.tokenindex=",",!0):!1},isWhite:function(){var e=this.expression.charCodeAt(this.pos);return 32===e||9===e||10===e||13===e?(this.pos++,!0):!1},isOp1:function(){for(var e="",t=this.pos;this.expression.length>t;t++){var i=this.expression.charAt(t);if(i.toUpperCase()===i.toLowerCase()&&(t===this.pos||"_"!=i&&("0">i||i>"9")))break;e+=i}return e.length>0&&e in this.ops1?(this.tokenindex=e,this.tokenprio=5,this.pos+=e.length,!0):!1},isOp2:function(){for(var e="",t=this.pos;this.expression.length>t;t++){var i=this.expression.charAt(t);if(i.toUpperCase()===i.toLowerCase()&&(t===this.pos||"_"!=i&&("0">i||i>"9")))break;e+=i}return e.length>0&&e in this.ops2?(this.tokenindex=e,this.tokenprio=5,this.pos+=e.length,!0):!1},isVar:function(){for(var e="",t=this.pos;this.expression.length>t;t++){var i=this.expression.charAt(t);if(i.toUpperCase()===i.toLowerCase()&&(t===this.pos||"_"!=i&&("0">i||i>"9")))break;e+=i}return e.length>0?(this.tokenindex=e,this.tokenprio=4,this.pos+=e.length,!0):!1},isComment:function(){var e=this.expression.charCodeAt(this.pos-1);return 47===e&&42===this.expression.charCodeAt(this.pos)?(this.pos=this.expression.indexOf("*/",this.pos)+2,1===this.pos&&(this.pos=this.expression.length),!0):!1}},e.Parser=m,m}("undefined"==typeof exports?{}:exports);$(function(){var e=
'<div class="showpanel"><button class="button show-load icon-folder-open">app</button></div>'+
'<div class="panel"><div class="choosepanel"><button class="button show-load icon-folder-open">app</button><button class="button close icon-cancel" title="close menu"></button></div>'+
'<div class="menu menu-load"><div class="controls"><form class="loadfromgist"><input class="loadfromgistinput" name="loadfromgistinput" placeholder="load app from gist url" type="text" /><button class="loadfromgistsubmit icon-ok" type="submit">load</button></form></div><div class="listing"><button class="button newblank icon-doc" title="new blank app">new</button><div class="currentapp"></div><div class="localapps"><h1>Saved Apps</h1></div><div class="examples"><h1>Examples</h1></div></div></div></div>',t='<h1>Current App</h1><div class="info"><h2 title="url, click to edit" class="seturl editable"></h2><p title="title, click to edit" class="settitle editable"></p><p title="description, click to edit" class="setdescription editable"></p></div><div class="savecontrols"><button class="savelocal icon-install">save local</button><button class="forklocal icon-split" title="save as... copy app and save under a new name">fork</button><button class="savegist icon-globe-1" title="save app to gist.github.com anonymously">save public</button><button class="deletelocal icon-trash" title="delete local app"></button></div><div class="permalink" title="last publicly saved version"></div>';
window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();var i=Backbone.View.extend({tagName:"div",className:"app",template:_.template(e),currentTemplate:_.template(t),frameCount:0,NativeNodes:{},plugins:{},events:{"click .close":"closePanels","click .show-load":"showLoad","click .newblank":"newBlank","submit .loadfromgist":"loadFromGist","click .savegist":"saveGist","click .savelocal":"saveLocal","click .forklocal":"forkLocal","click .deletelocal":"deleteLocal","blur .settitle":"setTitle","blur .setdescription":"setDescription","blur .seturl":"setUrl"},initialize:function(){this.render(),$("body").prepend(this.el),this.closePanels(),this.once("allLoaded",this.loadLocalApps,this)},allLoaded:function(){this.trigger("allLoaded"),window.requestAnimationFrame(this.renderAnimationFrame.bind(this))},render:function(){return this.$el.html(this.template()),this},renderAnimationFrame:function(e){e=void 0!==e?e:Date.now(),window.requestAnimationFrame(this.renderAnimationFrame.bind(this)),this.graph&&this.graph.view&&this.graph.view.renderAnimationFrame(e)},graph:null,shownGraph:null,wireColors:["#FF9292","#00C2EE","#DCA761","#8BB0FF","#96BD6D","#E797D7","#29C6AD"],wireColorIndex:0,selectedPort:null,getWireColor:function(){var e=this.wireColors[this.wireColorIndex];return this.wireColorIndex++,this.wireColorIndex>this.wireColors.length-1&&(this.wireColorIndex=0),e},addMenu:function(e,t,i){var n=this,r=$('<div class="menu menu-'+e+'"></div>').append(t).hide();this.$(".panel").append(r);var o=$('<button class="button show-'+e+'">'+e+"</button>").click(function(){n.showPanel(e)});i&&o.addClass(i),this.$(".showpanel").append(o),this.$(".choosepanel > .close").before(o.clone(!0))},addMenuSection:function(e,t,i){var n=$("<h1>").text(e);this.$(".menu-"+i+" .listing").append(n,t)},loadGraph:function(e){return this.graph&&(this.graph.remove(),this.graph=null),this.wireColorIndex=0,this.graph=new Iframework.Graph(e),e.info&&e.info.title&&(document.title="Meemoo: "+e.info.title),this.updateCurrentInfo(),this.shownGraph=this.graph,this.graph},showGraph:function(e){this.shownGraph&&this.shownGraph.view&&this.shownGraph.view.$el.hide(),e.view||e.initializeView(),this.shownGraph=e,this.shownGraph.view.$el.show(),this.shownGraph.view.unhidden||(this.shownGraph.view.unhidden=!0,this.shownGraph.view.rerenderEdges())},gotMessage:function(e){if(Iframework.graph){var t=Iframework.graph.get("nodes").get(e.data.nodeid);if(t)for(var i in e.data)if(e.data.hasOwnProperty(i)){var n=e.data[i];switch(i){case"message":t.sendFromFrame(n);break;case"info":t.infoLoaded(n);break;case"addInput":t.addInput(n);break;case"addOutput":t.addOutput(n);break;case"stateReady":t.iframeLoaded();break;case"set":t.setValues(n);break;default:}}}},_exampleGraphs:[],_loadedExample:null,loadExampleApps:function(e){this._exampleGraphs=this._exampleGraphs.concat(e);for(var t="",i=0;e.length>i;i++){var n=e[i].info.url;n&&(t+='<a href="#example/'+n+'" title="'+e[i].info.title+": "+e[i].info.description+'">'+n+"</a> <br />")}this.$(".menu-load .examples").append(t),this.graph||(this._loadedExample?this.loadExample(this._loadedExample):this._loadedLocal||this._loadedLocal||this._loadedGist||this.newBlank())},loadExample:function(e){this._loadedExample=e;for(var t=0;this._exampleGraphs.length>t;t++)if(this._exampleGraphs[t].info.url===e)return this._loadedLocalApp=null,this.loadGraph(this._exampleGraphs[t]),this.analyze("load","example",e),!0},closePanels:function(){this.$(".showpanel").show(),this.$(".panel").hide(),this.$(".graph").css("right","0px"),this.$(".menu").hide()},showPanel:function(e){if(this.$(".menu").hide(),this.$(".showpanel").hide(),this.$(".panel").show(),this.$(".graph").css("right","350px"),e)if(this.$(".menu-"+e).length>0)this.$(".menu-"+e).show(),this.trigger("showmenu:"+e);else{var t=this;_.delay(function(){t.$(".menu-"+e).show(),t.trigger("showmenu:"+e)},1e3)}},showLoad:function(){this.showPanel(),this.$(".menu-load").show()},loadFromGist:function(){var e=this.loadFromGistId(this.$(".loadfromgistinput").val());return e&&($(".loadfromgistinput").blur(),this.router&&this.router.navigate("gist/"+e),this.$(".loadfromgistinput").val("").attr("placeholder","loading..."),window.setTimeout(function(){this.$(".loadfromgistinput").attr("placeholder","load app from gist url")},1500)),!1},loadFromGistId:function(e){this._loadedGist=e;var t=e.split("/");return t.length>3&&"gist.github.com"===t[2]&&(e=t[t.length-1]),$.ajax({url:"https://api.github.com/gists/"+e,type:"GET",dataType:"jsonp"}).success(function(e){var t=[];for(var i in e.data.files)if(e.data.files.hasOwnProperty(i)){var n=JSON.parse(e.data.files[i].content);if(n){var r=e.data.html_url;n.info.parents&&n.info.parents.push||(n.info.parents=[]),-1===n.info.parents.indexOf(r)&&n.info.parents.push(r),t.push(n)}}t.length>0&&(Iframework.loadGraph(t[0]),Iframework.closePanels())}).error(function(e){console.warn("gist load error",e)}),this.analyze("load","gist",e),e},saveGist:function(){var e=this.graph.toJSON(),t={description:"meemoo app: "+e.info.title,"public":!0};t.files={};var i=e.info.url+".json";t.files[i]={content:JSON.stringify(e,null,"  ")},this.$(".savegist").prop("disabled",!0).text("saving..."),$.ajax({url:"https://api.github.com/gists",type:"POST",dataType:"json",data:JSON.stringify(t)}).success(function(t){var i=Iframework.graph.get("info");i.hasOwnProperty("parents")&&i.parents.push||(e.info.parents=[]),e.info.parents.push(t.html_url),Iframework.saveLocal(),Iframework.updateCurrentInfo(),Iframework.analyze("save","gist",t.id)}).error(function(e){var t="meemoo app: "+Iframework.graph.toJSON().info.title;Iframework.$(".permalink").html('api is down (;_;) copy your app source code to <a href="https://gist.github.com/?description='+encodeURIComponent(t)+'" target="_blank">gist.github.com</a>'),console.warn("gist save error",e)}).complete(function(){this.$(".savegist").prop("disabled",!1).text("save public")})},loadLocalApps:function(){this._localApps=new Iframework.LocalApps,this._localApps.fetch({success:function(){Iframework._localApps.each(function(e){e.initializeView()}),Iframework.graph||Iframework._loadedLocal&&Iframework.loadLocal(Iframework._loadedLocal)},error:function(){console.warn("error loading local apps")}})},_loadedLocal:null,_loadedLocalApp:null,loadLocal:function(e){if(this._loadedLocal=e,this._localApps){var t=this._localApps.getByUrl(e);return t?(t.load(),!0):(console.warn("Didn't find local app with matching url."),this.newBlank(),!1)}return!1},setKey:function(e){var t=window.prompt("Enter a url key",e);return t&&(t=this.encodeKey(t),this.graph.setInfo("url",t)),t},encodeKey:function(e){return e=e.toLowerCase().replace(/ /g,"-"),e=encodeURIComponent(e)},saveLocal:function(){for(this.graph.get("info")||this.graph.set({info:{}});!this.graph.get("info").hasOwnProperty("url")||""===this.graph.get("info").url;){var e;if(e=this.graph.get("info").hasOwnProperty("title")&&""!==this.graph.get("info").title?this.graph.get("info").title:"app-"+(new Date).getTime(),!this.setKey(e))return!1}var t,i=JSON.parse(JSON.stringify(this.graph)),n=i.info.url;if(this._loadedLocalApp)if(this._localApps.getByUrl(n)&&this._localApps.getByUrl(n)!==this._loadedLocalApp){if(!window.confirm('"'+n+'" already exists as a local app. Do you want to replace it?'))return!1;t=this._localApps.updateOrCreate(i)}else t=this._loadedLocalApp,t.save({graph:i}),t.trigger("change");else{if(this._localApps.getByUrl(n)&&!window.confirm('"'+n+'" already exists as a local app. Do you want to replace it?'))return!1;t=this._localApps.updateOrCreate(i)}return this._loadedLocalApp=t,this.analyze("save","local","x"),this.updateCurrentInfo(),Iframework.router.navigate("local/"+n),t},forkLocal:function(){this._loadedLocalApp=null;var e=this.graph.get("info").url+"-copy";this.setKey(e),this.saveLocal()},deleteLocal:function(){this._loadedLocalApp&&(this._loadedLocalApp.destroy(),this._loadedLocalApp=null)},setTitle:function(){var e=this.$(".currentapp .info .settitle").text();e!==this.graph.get("info").title&&this.graph.setInfo("title",e)},setDescription:function(){var e=this.$(".currentapp .info .setdescription").text();e!==this.graph.get("info").description&&this.graph.setInfo("description",e)},setUrl:function(){var e=this.$(".currentapp .info .seturl").text();e=this.encodeKey(e),e!==this.graph.get("info").url&&this.graph.setInfo("url",e)},updateCurrentInfo:function(){var e=this.graph.toJSON();if(this.$(".currentapp").html(this.currentTemplate(e)),this.$(".currentapp .seturl").text(decodeURIComponent(e.info.url)),this.$(".currentapp .settitle").text(e.info.title),this.$(".currentapp .setdescription").text(e.info.description),this.$(".editable").attr("contenteditable","true"),e.info.hasOwnProperty("parents")){var t=e.info.parents;if(t.length>0){var i=t[t.length-1],n=i.split("/");if(n.length>0){var r=n[n.length-1],o="http://meemoo.org/iframework/#gist/"+r,s=encodeURIComponent(o),a=encodeURIComponent(e.info.title),l=$("<span />").text(o).click(function(e){var t;if(document.body.createTextRange)t=document.body.createTextRange(),t.moveToElementText(e.target),t.select();else if(window.getSelection){var i=window.getSelection();t=document.createRange(),t.selectNodeContents(e.target),i.removeAllRanges(),i.addRange(t)}}),h=$('<a title="your saved gist" target="_blank" class="share icon-github"></a>').attr("href",i),d=$('<a title="share on facebook" target="_blank" class="share icon-facebook-rect"></a>').attr("href","https://www.facebook.com/sharer.php?u="+s+"&t="+a),u=" "+e.info.title+" #meemoo "+e.info.description;u.length>=120&&(u=u.substr(0,115)+"..."),u=o+u;var c=$('<a title="post to twitter" target="_blank" class="share icon-twitter-bird"></a>').attr("href","https://twitter.com/intent/tweet?text="+encodeURIComponent(u));this.$(".currentapp .permalink").empty().append(l).append(" ").append(h).append(d).append(c)}}}this._loadedLocalApp?this.$(".currentapp .deletelocal").show():this.$(".currentapp .deletelocal").hide()},newBlank:function(){this.loadGraph({info:{author:"meemoo",title:"Untitled",description:"Meemoo app description",parents:[],url:""},nodes:[],edges:[]}),this._loadedLocalApp=null,this.showPanel("library"),Iframework.router.navigate("new")},analyze:function(){}});window.Iframework=new i,window.addEventListener("message",Iframework.gotMessage,!1)}),$(function(){Iframework.util={types:{undefined:"undefined",number:"number","boolean":"boolean",string:"string","[object Function]":"function","[object RegExp]":"regexp","[object Array]":"array","[object Date]":"date","[object Error]":"error","[object HTMLCanvasElement]":"HTMLCanvasElement","[object ImageData]":"ImageData"},type:function(e){return this.types[typeof e]||this.types[Object.prototype.toString.call(e)]||(e?"object":"null")},imageTypes:["png","gif","jpg","jpeg","webp"],isImageURL:function(e){var t=e.split(".");if(t.length>1){var i=t[t.length-1];return this.imageTypes.indexOf(i)>-1}return!1},imageDrop:function(e,t){if(!t)return!1;e.stopPropagation();var i=e.data.self,n=t.helper.data("meemoo-drag-type");if(!n||"canvas"!==n)return!1;var r=e.data.inputName;if(!r)return!1;var o,s=t.helper.data("meemoo-image-url");if(s){var a=new Image;a.crossOrigin="anonymous",a.onload=function(){o=document.createElement("canvas");var e=o.getContext("2d");o.width=a.width,o.height=a.height,e.drawImage(a,0,0),i.receive(r,o)},a.src=s}else{if(o=t.helper.data("meemoo-drag-canvas"),!o)return!1;i.receive(r,o)}},fitAndCopy:function(e,t){var i,n,r,o,s=t.width,a=t.height,l=s/a,h=e.width,d=e.height,u=h/d;l>=u?(r=h,o=Math.floor(h/l),i=0,n=Math.floor((d-o)/2)):(r=Math.floor(d*l),o=d,i=Math.floor((h-r)/2),n=0);var c=t.getContext("2d");c.drawImage(e,i,n,r,o,0,0,s,a)}}}),$(function(){Iframework.Event=Backbone.Model.extend({defaults:function(){return{action:"",args:{}}},initialize:function(){}}),Iframework.EventsHistory=Backbone.Collection.extend({model:Iframework.Event}),Mousetrap.bind(["command+z","ctrl+z"],function(){var e=window.Iframework.shownGraph,t=e.eventsHistory.last();if("removeNode"===t.get("action")){var i=t.get("args").node,n=e.usedIds.indexOf(i.get("id"));e.usedIds.splice(n,1),e.addNode(i);var r;for(r=0;i.Inputs.length>r;r++)i.view.addInput(i.Inputs.at(r));for(r=0;i.Outputs.length>r;r++)i.view.addOutput(i.Outputs.at(r));var o=t.get("args").edges;for(r=0;o.length>r;r++)e.addEdge(o[r])}e.eventsHistory.pop()})}),$(function(){Iframework.LocalApp=Backbone.Model.extend({initializeView:function(){return this.view||(this.view=new Iframework.LocalAppView({model:this})),this.view},load:function(){Iframework._loadedLocalApp=this;var e=JSON.parse(JSON.stringify(this.get("graph")));Iframework.loadGraph(e)},toJSON:function(){return{id:this.id,graph:this.get("graph")}}}),Iframework.LocalApps=Backbone.Collection.extend({model:Iframework.LocalApp,localStorage:new Backbone.LocalStorage("LocalApps"),getByUrl:function(e){var t=this.find(function(t){return t.get("graph").info.url===e});return t},updateOrCreate:function(e){var t;return t=this.find(function(t){return t.get("graph").info.url===e.info.url}),t?(t.save({graph:e}),t.trigger("change")):(t=this.create({graph:e}),t.initializeView()),t}})}),$(function(){var e='<a class="url" href="#local/<%= graph.info.url %>"></a> - <a class="macro" title="load as subgraph into current graph" href="#">sub</a> ';Iframework.LocalAppView=Backbone.View.extend({tagName:"div",className:"localapp",template:_.template(e),events:{"click .macro":"loadAsMacro"},initialize:function(){return this.render(),Iframework.$(".localapps").append(this.el),this.model.on("change",this.update,this),this.model.on("destroy",this.remove,this),this},render:function(){this.$el.html(this.template(this.model.toJSON())),this.$(".url").text(decodeURIComponent(this.model.get("graph").info.url))},update:function(){this.render(),Iframework.updateCurrentInfo()},loadAsMacro:function(e){return e.preventDefault(),Iframework.shownGraph.addNode({src:"meemoo:subgraph/subgraph",state:{label:decodeURIComponent(this.model.get("graph").info.url),graph:this.model.get("graph")}}),!1},remove:function(){this.$el.remove()}})}),$(function(){Iframework.Graph=Backbone.Model.extend({loaded:!1,defaults:{info:{author:"meemoo",title:"Untitled",description:"Meemoo app description",parents:[],url:""},nodes:[],edges:[]},usedIds:[],edgeCount:0,eventsHistory:[],isSubgraph:!1,initialize:function(){var e=this.get("parentGraph");if(e&&(this.isSubgraph=!0,this.parentGraph=e),this.usedIds=[],this.attributes.nodes){var t=this.attributes.nodes;this.attributes.nodes=new Iframework.Nodes;for(var i=0;t.length>i;i++){var n=this.makeNode(t[i]);n&&this.addNode(n)}}if(this.attributes.edges){var r=this.attributes.edges;this.attributes.edges=new Iframework.Edges;for(var o=0;r.length>o;o++){r[o].parentGraph=this;var s=new Iframework.Edge(r[o]);this.addEdge(s)}}this.eventsHistory=new Iframework.EventsHistory;var a=this;_.defer(function(){a.testLoaded()}),this.on("change",this.graphChanged)},testLoaded:function(){var e=!0;return this.get("nodes").each(function(t){t.hasOwnProperty("lazyLoadType")&&(Iframework.NativeNodes.hasOwnProperty(t.lazyLoadType)?t.view&&!t.Native&&t.view.initializeNative():e=!1)},this),e&&this.initializeView(),e},initializeView:function(){this.view||(this.view=new Iframework.GraphView({model:this}))},setInfo:function(e,t){var i=this.get("info");i[e]=t,this.trigger("change")},makeNode:function(e){if(!e.src)return!1;e.parentGraph=this;var t;if(Iframework.util.isImageURL(e.src)){var i=e.src;e.src="meemoo:image/in",e.state||(e.state={}),e.state.url=i}var n=e.src.split(":");if(2>n.length)return!1;if("meemoo"===n[0]){var r=n[n.length-1],o=r.split("/");r=o.join("-");var s=this;o[0]&&o[1]&&yepnope([{test:Iframework.NativeNodes.hasOwnProperty(o[0]),nope:"src/nodes/"+o[0]+".js"},{test:Iframework.NativeNodes.hasOwnProperty(o[0]+"-"+o[1]),nope:"src/nodes/"+o[0]+"-"+o[1]+".js",complete:function(){_.defer(function(){s.testLoaded()})}}]),t=new Iframework.NodeBox(e),t.lazyLoadType=r}else t=new Iframework.NodeBoxIframe(e);return t},addNode:function(e){if(!e.cid&&(e=this.makeNode(e),!e))return!1;var t=this.get("nodes").length,i=parseInt(e.get("id"),10);for(i!==i&&e.set({id:t});this.usedIds.indexOf(e.get("id"))>=0;)t++,e.set({id:t});this.usedIds.push(e.get("id"));for(var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r="",o=0;5>o;o++)r+=n.charAt(Math.floor(Math.random()*n.length));return e.frameIndex="frame_"+e.get("id")+"_"+Iframework.frameCount++ +r+"_through",this.get("nodes").add(e),this.view&&this.view.addNode(e),this.trigger("change"),e},addEdge:function(e){var t=this.get("edges").any(function(t){return t.get("source")[0]===e.get("source")[0]&&t.get("source")[1]===e.get("source")[1]&&t.get("target")[0]===e.get("target")[0]&&t.get("target")[1]===e.get("target")[1]});return t?(console.warn("duplicate edge ignored",e),!1):(this.trigger("change"),this.get("edges").add(e))},remove:function(){this.get("nodes").each(function(e){e.remove(!1)}),this.view&&this.view.remove()},removeNode:function(e){var t=[];this.get("edges").each(function(i){i.Source&&i.Target&&(i.Source.parentNode===e||i.Target.parentNode===e)&&t.push(i)},this),_.each(t,function(e){e.remove()}),this.view&&this.view.removeNode(e),this.get("nodes").remove(e),this.eventsHistory.add(new Iframework.Event({action:"removeNode",args:{node:e,edges:t}})),this.trigger("change")},removeEdge:function(e){e.disconnect(),this.get("edges").remove(e),this.view&&this.view.removeEdge(e),this.trigger("change")},checkLoaded:function(){for(var e=0;this.get("nodes").length>e;e++)if(this.get("nodes").at(e).loaded===!1)return!1;this.loaded=!0;var t=this;return setTimeout(function(){t.connectEdges()},500),!0},reconnectEdges:function(){for(var e=0;this.get("edges").length>e;e++)this.get("edges").at(e).disconnect();var t=this;_.delay(function(){t.connectEdges()},500)},connectEdges:function(){this.get("edges").each(function(e){e.connected||e.connect()}),this.get("nodes").each(function(e){e.setState()})},graphChanged:function(){Iframework.trigger("change",this)},toJSON:function(){return{info:this.get("info"),nodes:this.get("nodes"),edges:this.get("edges")}}}),Iframework.Graphs=Backbone.Collection.extend({model:Iframework.Graph})}),$(function(){var e='<div class="edges"><svg class="edgesSvg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="300" height="300"></svg></div><div class="nodes" /><div class="iframework-graph-nav" style="display:none;"><button class="show-parent-graph">back to parent graph</button></div>';Iframework.GraphView=Backbone.View.extend({tagName:"div",className:"graph",template:_.template(e),events:{click:"click",dragenter:"ignoreDrag",dragover:"ignoreDrag",drop:"drop",selectablestart:"selectableStart",selectablestop:"selectableStop","click .show-parent-graph":"showParentGraph"},unhidden:!1,initialize:function(){this.render(),this.model.isSubgraph&&(this.$(".iframework-graph-nav").show(),this.$el.hide()),Iframework.$el.prepend(this.el),this.edgesSvg=this.$(".edgesSvg")[0],Iframework.$(".panel").is(":visible")&&this.$el.css("right","350px"),this.model.get("nodes").each(this.addNode.bind(this)),this.$el.droppable({accept:".addnode, .canvas, .meemoo-plugin-images-thumbnail"});var e="ontouchstart"in document;e||this.$el.selectable({filter:".module",delay:20}),this.resizeEdgeSVG()},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},renderAnimationFrame:function(e){this.model.get("nodes").each(function(t){t.view.Native&&t.view.Native.renderAnimationFrame(e)})},click:function(){$(".edge-edit").remove(),Iframework.selectedPort=null,this.$(".module").removeClass("active"),this.$(".module").removeClass("ui-selected")},ignoreDrag:function(e){e.originalEvent.stopPropagation(),e.originalEvent.preventDefault()},drop:function(e,t){this.ignoreDrag(e);var i=e.originalEvent.dataTransfer;if(i&&(i.files,i.files.length>0)){var n=i.files[0],r=n.type.split("/"),o={x:this.el.scrollLeft+e.originalEvent.clientX+10,y:this.el.scrollTop+e.originalEvent.clientY+35};if("image"===r[0])o.src="meemoo:image/in",o.state={url:window.URL.createObjectURL(n)},Iframework.shownGraph.addNode(o);else if("video"===r[0])o.src="meemoo:video/player",o.state={url:window.URL.createObjectURL(n)},Iframework.shownGraph.addNode(o);else if("text"===r[0]){var s=new FileReader;s.onload=function(e){o.src="meemoo:ui/textarea",o.state={value:e.target.result},Iframework.shownGraph.addNode(o)},s.readAsText(n)}}if(!t)return!1;var a=t.helper.data("meemoo-drag-type");if(!a)return!1;var l={x:Math.round(this.el.scrollLeft+t.offset.left+10),y:Math.round(this.el.scrollTop+t.offset.top+35)};switch(a){case"library-module":var h=t.draggable.data("module");h&&h.view.dragAddNode(l);break;case"canvas":var d=t.helper.data("meemoo-drag-canvas");if(d){l.src="meemoo:image/in",l.canvas=d;var u=t.helper.data("meemoo-image-url");u&&"http"===u.slice(0,4)&&(l.state={},l.state.url=u),Iframework.shownGraph.addNode(l)}break;default:}return!1},addNode:function(e){this.$(".nodes").append(e.initializeView().el),e.lazyLoadType&&e.view.initializeNative()},addEdge:function(e){e.initializeView(),e.Source.view&&e.Source.view.resetRelatedEdges(),e.Target.view&&e.Target.view.resetRelatedEdges()},remove:function(){this.$el.remove()},removeNode:function(e){e.view&&e.view.remove()},removeEdge:function(e){e.Source&&e.Source.view&&e.Source.view.resetRelatedEdges(),e.Target&&e.Target.view&&e.Target.view.resetRelatedEdges(),e.view&&e.view.remove()},resizeEdgeSVG:_.debounce(function(){var e=this.$(".edgesSvg")[0],t=e.getBBox(),i=t.x+t.width+100,n=t.y+t.height+100;100===i&&100===n&&(i=this.$el.width(),n=this.$el.height()),i>e.getAttribute("width")&&e.setAttribute("width",Math.round(i)),n>e.getAttribute("height")&&e.setAttribute("height",Math.round(n))},100),selectableStart:function(){this.maskFrames()},selectableStop:function(){this.unmaskFrames()},selectAll:function(){this.$(".module").addClass("ui-selected")},selectNone:function(){this.$(".module").removeClass("ui-selected")},cut:function(){this.copy();var e;for(e=0;Iframework._copied.nodes.length>e;e++)Iframework._copied.nodes[e].x-=50,Iframework._copied.nodes[e].y-=50;var t=this.$(".module.ui-selected");for(e=0;t.length>e;e++)$(t[e]).data("iframework-node-view").removeModel()},copy:function(){var e,t,i={nodes:[],edges:[]},n=this.$(".module.ui-selected");for(e=0;n.length>e;e++)t=$(n[e]).data("iframework-node-view").model,i.nodes.push(JSON.parse(JSON.stringify(t)));this.model.get("edges").each(function(r){var o,s=!1;for(e=0;n.length>e;e++)t=$(n[e]).data("iframework-node-view").model,r.Source.node===t&&(o=!0),r.Target.node===t&&(s=!0);o&&s&&i.edges.push(JSON.parse(JSON.stringify(r)))},this),Iframework._copied=i},paste:function(){var e=Iframework._copied;if(e&&e.nodes.length>0){var t=[];this.$(".module").removeClass("ui-selected");for(var i=0;e.nodes.length>i;i++){var n=JSON.parse(JSON.stringify(e.nodes[i]));n.x+=50,n.y+=50,n.parentGraph=this.model;var r=this.model.addNode(n);r.copiedFrom=n.id,t.push(r),r.view&&r.view.select()}for(var o=0;e.edges.length>o;o++){for(var s=JSON.parse(JSON.stringify(e.edges[o])),a={source:[],target:[]},l=0;t.length>l;l++){var h=t[l];s.source[0]===h.copiedFrom&&(a.source[0]=h.id),s.target[0]===h.copiedFrom&&(a.target[0]=h.id)}a.source[1]=s.source[1],a.target[1]=s.target[1],a.parentGraph=this.model,a=new Iframework.Edge(a),this.model.addEdge(a)
}}},maskFrames:function(){$(".iframe-type").append('<div class="iframemask" />')},unmaskFrames:function(){$(".iframemask").remove()},showParentGraph:function(){this.model.parentGraph&&Iframework.showGraph(this.model.parentGraph)},rerenderEdges:function(){this.model.get("edges").each(function(e){e.view&&e.view.redraw()},this)}})}),$(function(){Iframework.Node=Backbone.Model.extend({send:function(){},receive:function(){},sendFromFrame:function(){},iframeLoaded:function(){}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){Iframework.NodeView=Backbone.View.extend({send:function(e){this.model.send(e)},receive:function(e){this.model.receive(e)}})}),$(function(){Iframework.NodeBox=Iframework.Node.extend({loaded:!1,defaults:function(){return{src:"",x:100,y:400,z:0,w:200,h:210,state:{}}},info:{title:"native-node",description:"extend me"},initialize:function(){this.Inputs=new Iframework.PortsIn,this.Outputs=new Iframework.PortsOut,this.parentGraph=this.get("parentGraph"),this.on("change",this.nodeChanged)},initializeView:function(){return this.view=new Iframework.NodeBoxView({model:this}),this.view},send:function(e,t){var i=this;_.defer(function(){i.trigger("send:"+e,t)})},receive:function(e,t){this.view.Native&&this.view.Native.receive(e,t)},infoLoaded:function(e){this.info=e,this.view&&this.view.infoLoaded(e)},setState:function(){var e=this.get("state");if(e&&this.view.Native)for(var t in e)this.setEquation(t,e[t]),this.view.Native["input"+t]?this.view.Native["input"+t](e[t]):this.view.Native["_"+t]=e[t]},addInput:function(e){void 0===e.id&&(e.id=e.name),e.parentNode=this;var t=this.Inputs.get(e.id);if(t)return t.set(e),void 0;var i=new Iframework.PortIn(e);i.isIn=!0,i.node=this,i.parentGraph=this.parentGraph,this.Inputs.add(i),this.view&&this.view.addInput(i);var n=this.get("state");return e.hasOwnProperty("default")&&""!==e["default"]&&!n.hasOwnProperty(e.name)&&(n[e.name]=e["default"]),i},addOutput:function(e){void 0===e.id&&(e.id=e.name),e.parentNode=this;var t=this.Outputs.get(e.id);if(t)return t.set(e),void 0;var i=new Iframework.PortOut(e);return i.isIn=!1,i.node=this,i.parentGraph=this.parentGraph,this.Outputs.add(i),this.view&&this.view.addOutput(i),i},nodeChanged:function(){this.parentGraph&&this.parentGraph.trigger("change")},remove:function(e){e?this.parentGraph.removeNode(this):this.view&&this.view.remove()},setValues:function(e){for(var t in e)this.setValue(t,e[t]);this.nodeChanged()},setValue:function(e,t){this.setEquation(e,t),this.get("state")[e]=t,this.nodeChanged()},setEquation:function(e,t){if(this.view.Native){var i=this.Inputs.get(e);if(i){var n=i.get("type");("int"===n||"float"===n||"number"===n)&&("="===(""+t).substr(0,1)?this.view.Native.setEquation(e,t.substr(1)):this.view.Native.setEquation(e))}}},toString:function(){return this.info?"Native node "+this.get("id")+": "+this.info.title:"Native node "+this.get("id")},toJSON:function(){return{id:this.id,src:this.get("src"),x:this.get("x"),y:this.get("y"),w:this.get("w"),h:this.get("h"),state:this.get("state")}}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){var e='<div class="module" style="left:<%= get("x")-10 %>px;top:<%= get("y")-30 %>px;width:<%= get("w")+20 %>px;height:<%= get("h")+40 %>px;" ><div class="outer"></div><div class="ports ports-in"></div><div class="ports ports-out"></div><h1 class="title"><span class="module-icon module-icon-small"></span><span class="node-box-title-name">...</span></h1><button title="show controls" type="button" class="showcontrols icon-left-open"></button><div class="controls"><button title="remove module" type="button" class="remove icon-trash"></button><a title="view source" type="button" class="viewsource button icon-cog"></a><button title="hide controls" type="button" class="hidecontrols icon-right-open"></button></div><div class="inner"></div></div>';Iframework.NodeBoxView=Iframework.NodeView.extend({tagName:"div",className:"node",template:_.template(e),events:{"dragstart .module":"dragStart","drag .module":"drag","dragstop .module":"dragStop","resizestart .module":"resizestart","resize .module":"resize","resizestop .module":"resizestop","mousedown .module, .title":"mousedown","click .module, .title":"click","click .showcontrols":"showControls","click .hidecontrols":"hideControls","click .remove":"removeModel"},initialize:function(){this.render(),this.$(".module").data({"iframework-node-view":this}).draggable({handle:"h1",helper:function(){var e=$(this);return $('<div class="ui-draggable-helper" style="width:'+e.width()+"px; height:"+e.height()+'px">')}}).resizable({minHeight:100,minWidth:100,helper:"ui-draggable-helper"}),this.model.lazyLoadType?this.$(".viewsource").attr({href:"src/nodes/"+this.model.lazyLoadType+".js",target:"_blank"}):this.$(".viewsource").hide(),this.$("h1").disableSelection(),this.mousedown()},initializeNative:function(){this.Native||Iframework.NativeNodes.hasOwnProperty(this.model.lazyLoadType)&&(this.Native=new Iframework.NativeNodes[this.model.lazyLoadType]({model:this.model}),this.$(".inner").append(this.Native.$el),this.model.loaded=!0,this.model.parentGraph.checkLoaded())},render:function(){return this.$el.html(this.template(this.model)),this},infoLoaded:function(e){this.$("h1").attr("title",this.model.get("id")+": "+(e.author?"by "+e.author+": ":"")+e.description),this.$(".node-box-title-name").text(e.title),this.model.lazyLoadType&&this.$(".module-icon").addClass("module-icon-"+this.model.lazyLoadType)},_alsoDrag:[],_dragDelta:{},dragStart:function(e){if(e.target===this.$(".module")[0]){this.model.parentGraph.view.maskFrames(),this.$(".module").hasClass("ui-selected")||this.click(e);var t=this;this._alsoDrag=[],this.model.parentGraph.view.$(".ui-selected").each(function(){if(t.$(".module")[0]!==this){var e=$(this),i={left:parseInt(e.css("left"),10),top:parseInt(e.css("top"),10)};e.data("ui-draggable-alsodrag-initial",i);var n=$('<div class="ui-draggable-helper">').css({width:e.width(),height:e.height(),left:i.left,top:i.top});e.parent().append(n),e.data("ui-draggable-alsodrag-helper",n),t._alsoDrag.push(e)}})}},drag:function(e){if(e.target===this.$(".module")[0]&&this._alsoDrag.length){var t=$(e.target).data("ui-draggable"),i=t.originalPosition,n={top:t.position.top-i.top||0,left:t.position.left-i.left||0};_.each(this._alsoDrag,function(e){var t=e.data("ui-draggable-alsodrag-initial"),i=e.data("ui-draggable-alsodrag-helper");i.css({left:t.left+n.left,top:t.top+n.top})})}},dragStop:function(e,t){if(e.target===this.$(".module")[0]){var i=parseInt(t.position.left,10),n=parseInt(t.position.top,10);this.moveToPosition(i,n),this._alsoDrag.length&&(_.each(this._alsoDrag,function(e){e.data("ui-draggable-alsodrag-initial");var t=e.data("ui-draggable-alsodrag-helper"),i=e.data("iframework-node-view");i.moveToPosition(parseInt(t.css("left"),10),parseInt(t.css("top"),10)),t.remove(),e.data("ui-draggable-alsodrag-initial",null),e.data("ui-draggable-alsodrag-helper",null)}),this._alsoDrag=[]),this.model.parentGraph.view.unmaskFrames()}},moveToPosition:function(e,t){this.$(".module").css({left:e,top:t}),this.model.set({x:e+10,y:t+30})},resizestart:function(){this.model.parentGraph.view.maskFrames()},resize:function(){},resizestop:function(e,t){this.model.parentGraph.view.unmaskFrames();var i=t.size.width,n=t.size.height;this.model.set({w:i-20,h:n-40}),this.Native&&this.Native.resize(i,n),this.model.parentGraph.view.resizeEdgeSVG()},mousedown:function(e){var t=0;$("div.module").each(function(){var e=Number($(this).css("z-index"));e>t&&(t=e)}),this.$(".module").css("z-index",t+1),e&&e.stopPropagation()},click:function(e){e.ctrlKey||e.metaKey?this.$(".module").toggleClass("ui-selected"):(this.model.parentGraph.view.$(".ui-selected").removeClass("ui-selected"),this.$(".module").addClass("ui-selected")),e.stopPropagation()},select:function(){this.$(".module").addClass("ui-selected")},addInput:function(e){this.$(".ports-in").append(e.initializeView().el)},addOutput:function(e){this.$(".ports-out").append(e.initializeView().el)},showControls:function(){this.$(".showcontrols").hide(),this.$(".controls").show()},hideControls:function(){this.$(".showcontrols").show(),this.$(".controls").hide()},removeModel:function(){this.model.remove(!0)},remove:function(){this.Native&&this.Native.remove(),this.$el.remove()},refresh:function(){},popout:function(){}})}),$(function(){var e='<div class="info" />';Iframework.NodeBoxNativeView=Backbone.View.extend({tagName:"div",className:"nativenode",template:_.template(e),info:{title:"native-node-view",description:"extend me"},inputs:{},outputs:{},initialize:function(){this.render(),this.model.infoLoaded(this.info);for(var e in this.inputs)if(this.inputs.hasOwnProperty(e)){var t=this.inputs[e];t.name=e,this.model.addInput(t)}for(var i in this.outputs)if(this.outputs.hasOwnProperty(i)){var n=this.outputs[i];n.name=i,this.model.addOutput(n)}return this.initializeCategory(),this.initializeModule(),this},initializeCategory:function(){},initializeModule:function(){},render:function(){return this.$el.html(this.template(this.model)),this},redraw:function(){},_triggerRedraw:!1,_lastRedraw:0,renderAnimationFrame:function(e){this._triggerRedraw&&(this._triggerRedraw=!1,this.redraw(e),this._lastRedraw=e)},set:function(e,t){this.model.setValue(e,t)},send:function(e,t){this.model.send(e,t)},setEquation:function(e,t){if(this.equations||(this.equations={}),t)try{var i=Parser.parse(t);this.equations[e]=i}catch(n){this.equations[e]=function(e){return e.x}}else this.equations[e]&&(this.equations[e]=void 0)},receive:function(e,t){this.equations&&this.equations[e]&&(t=this.equations[e].evaluate({x:t})),this["input"+e]?this["input"+e](t):(this["_"+e]=t,this._triggerRedraw=!0)},toString:function(){return"Native view: "+this.model.get("id")+": "+this.info.title},resize:function(){},connectEdge:function(){},disconnectEdge:function(){},remove:function(){}})}),$(function(){Iframework.NodeBoxIframe=Iframework.NodeBox.extend({initializeView:function(){return this.view=new Iframework.NodeBoxIframeView({model:this}),this.view},info:{title:"iframe-node",description:"extend me"},sendFromFrame:function(e){var t=e.output,i=e.value;"ImageData"===Iframework.util.type(e.value)&&(i=this.makeCanvas(i)),this.send(t,i)},receive:function(e,t){if(this.view&&this.view.iframeloaded){if("HTMLCanvasElement"===Iframework.util.type(t))try{t=t.getContext("2d").getImageData(0,0,t.width,t.height)}catch(i){return!1}var n={};n[e]=t,this.view.iframe.contentWindow.postMessage(n,"*")}else console.error("wat "+this.id+" "+this.frameIndex)},setState:function(){var e=this.get("state");e&&this.receive({setState:e})},iframeLoaded:function(){this.loaded=!0,this.parentGraph.checkLoaded()},toString:function(){return this.info?"Iframe node "+this.get("id")+": "+this.info.title:"Iframe node "+this.get("id")},makeCanvas:function(e){return this.canvas||(this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d")),(this.canvas.width!==e.width||this.canvas.height!==e.height)&&(this.canvas.width=e.width,this.canvas.height=e.height),this.context.putImageData(e,0,0),this.canvas}}),Iframework.Nodes=Backbone.Collection.extend({model:Iframework.Node})}),$(function(){Iframework.NodeBoxIframeView=Iframework.NodeBoxView.extend({initialize:function(){Iframework.NodeBoxView.prototype.initialize.call(this),this.$("button.remove").after($('<button title="reload iframe" type="button" class="refresh icon-cw"></button>')),this.events["click .refresh"]="refresh",this.$(".inner").addClass("iframe-type");var e=this;this.iframe.onload=function(){e.iframeloaded=!0}},render:function(){return this.$el.html(this.template(this.model)),this.iframe=document.createElement("iframe"),$(this.iframe).attr({"class":"iframe",name:this.model.frameIndex,src:this.model.get("src")}),this.$(".inner").html(this.iframe),this},refresh:function(){this.$("iframe")[0].src=this.model.get("src")}})}),$(function(){Iframework.Port=Backbone.Model.extend({defaults:{name:"",type:"",description:"","default":null},initialize:function(){""===this.get("type")&&this.set("type","all"),this.parentNode=this.get("parentNode"),this.set("type_class",this.get("type").split(":")[0]),this.Edges=new Iframework.Edges},connect:function(e){this.Edges.add(e)},disconnect:function(e){this.Edges.remove(e)},remove:function(){for(;this.Edges.length>0;){var e=this.Edges.at(0);this.parentNode.parentGraph.removeEdge(e)}this.view&&this.view.remove()}}),Iframework.Ports=Backbone.Collection.extend({model:Iframework.Port})}),$(function(){var e='<div class="edge-edit"><button title="close" class="close icon-cancel"></button><h2><%= name %> (<%= type %>)</h2><p><%= description %></p><p><button class="publish-port">Publish</button></p></div>',t='<div class="edge-edit-item" id="<%= model.cid %>"><span><%= label() %></span><button title="disconnect" class="disconnect icon-scissors" type="button"></button></div>';Iframework.PortView=Backbone.View.extend({tagName:"div",className:"port",popupTemplate:_.template(e),edgeEditTemplate:_.template(t),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","submit .manualinput":"manualinput","click .publish-port":"publishPort"},initialize:function(){return this.render(),this},dragstart:function(e,t){this.model.node.parentGraph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var i=new Iframework.EdgeView;Iframework.edgePreview=i,this.drag(e,t),this.$(".plugend").show(),e.stopPropagation()},drag:function(e,t){if(Iframework.edgePreview){var i=t.offset.left+Iframework.shownGraph.view.el.scrollLeft,n=t.offset.top+8+Iframework.shownGraph.view.el.scrollTop,r=this.portOffsetLeft(),o=this.portOffsetTop(),s={fromX:this.model.isIn?i-2:r,fromY:this.model.isIn?n:o,toX:this.model.isIn?r:i+20,toY:this.model.isIn?o:n};Iframework.edgePreview.setPositions(s),Iframework.edgePreview.redraw()}e.stopPropagation()},dragstop:function(e){this.model.node.parentGraph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=void 0,1>this.relatedEdges().length&&this.$(".plugend").hide(),e.stopPropagation()},drop:function(e,t){if(this.armDelete)this.armDelete=!1;else{var i=$(t.draggable).data("model"),n=this.model,r=this.model.isIn?i:n,o=this.model.isIn?n:i,s=new Iframework.Edge({source:[r.node.get("id"),r.get("name")],target:[o.node.get("id"),o.get("name")],parentGraph:this.model.parentGraph});Iframework.edgePreview&&(s._color=Iframework.edgePreview._color),s.parentGraph.addEdge(s)&&s.connect()}e.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var e,t=0;return _.each(this.relatedEdges(),function(i){i.view._z>=t&&(t=i.view._z,e=i)},this),e},unplugstart:function(e){this.model.node.parentGraph.view.maskFrames();var t=this.topConnectedEdge();if(!t)return!1;this.unpluggingEdge=t,this.unpluggingEdge.view.dim(),1===this.relatedEdges().length&&this.$(".plugend").hide();var i=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",i),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var n=new Iframework.EdgeView;n.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=n,this.armDelete=!0,e.stopPropagation()},unplugdrag:function(e,t){if(Iframework.edgePreview&&this.unpluggingEdge){var i=t.offset.left+Iframework.shownGraph.view.el.scrollLeft,n=t.offset.top+6+Iframework.shownGraph.view.el.scrollTop,r=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,o=r.portOffsetLeft(),s=r.portOffsetTop(),a={fromX:this.model.isIn?o:i-2,fromY:this.model.isIn?s:n,toX:this.model.isIn?i+20:o,toY:this.model.isIn?n:s};Iframework.edgePreview.setPositions(a),Iframework.edgePreview.redraw()}e.stopPropagation()},unplugstop:function(e,t){this.armDelete&&this.unpluggingEdge?this.model.parentGraph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(e,t)},clickhole:function(e){$("div.edge-edit").remove();var t=this.$(".hole"),i=this.model.isIn;this.model.get("name");var n=this.popupTemplate(this.model.toJSON());n=$(n),this.$el.append(n),n.children("button.close").button({icons:{primary:"icon-cancel"},text:!1}).click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var r=this.model.get("type").substring(0,3);if(i){var o=!1,s=$("<form />").attr({id:this.model.node.id+"_"+this.model.get("name"),"class":"manualinput"});if("int"===r||"num"===r||"flo"===r)o=!0,s.append($("<input />").attr({type:"number",min:t.data("min"),max:t.data("max"),step:"any",value:this.model.node.get("state")[this.model.get("name")]}));else if("col"===r||"str"===r)o=!0,s.append($("<input />").attr({type:"text",maxlength:t.data("max"),value:this.model.node.get("state")[this.model.get("name")]}));else if("boo"===r){o=!0;var a=this.model.node.get("state")[this.model.get("name")];a=Boolean(a)&&"false"!==a,s.append($("<input />").attr({type:"checkbox",checked:a}))}else"ban"===r&&(s.append("<label>Send bang:</label> "),o=!0);o&&(s.append($("<button></button>").html("send").attr({type:"submit","class":"send",title:"send value to module"}).button({icons:{primary:"icon-ok"},text:!1})),n.append(s))}$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(n.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(e){var t=this.edgeEditTemplate(e.view);n.append(t)},this)),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),e.stopPropagation()},manualinput:function(){var e,t=this.model.get("name");this.$(".manualinput").children("input")&&(e=this.$(".manualinput").children("input").val()),this.$(".manualinput").children("input:checkbox").length>0&&(e=this.$(".manualinput").children("input:checkbox").is(":checked")?!0:!1),"int"===this.model.get("type")&&(e=parseInt(e,10)),("number"===this.model.get("type")||"float"===this.model.get("type"))&&(e=parseFloat(e)),void 0===e&&(e="!");var i={};return i[t]=e,this.model.node.receive(i),this.model.node.get("state")[t]=e,this.model.node.trigger("change"),!1},disconnect:function(e){var t=this.model.parentGraph.get("edges").getByCid($(e.target).parents(".edge-edit-item").attr("id"));t&&this.model.parentGraph.removeEdge(t),$("div.edge-edit").remove(),Iframework.selectedPort=null,e.stopPropagation()},portOffsetLeft:function(){var e=this.$(".hole").offset();return e?e.left+7+this.model.parentNode.parentGraph.view.el.scrollLeft:0},portOffsetTop:function(){var e=this.$(".hole").offset();return e?e.top+10+this.model.parentNode.parentGraph.view.el.scrollTop:0},_relatedEdges:null,relatedEdges:function(){return null===this._relatedEdges&&(this._relatedEdges=this.model.parentGraph.get("edges").filter(function(e){return e.Source===this.model||e.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide(),this.model.node.view.resetRelatedEdges()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var e=this.topConnectedEdge();e&&e.view&&e.view.highlight()}},highlight:function(){var e=this.$(".plugend");e.addClass("highlight"),setTimeout(function(){e.removeClass("highlight")},1e3)},publishPort:function(){}})}),$(function(){Iframework.PortIn=Iframework.Port.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortInView({model:this}),this.view}}),Iframework.PortsIn=Backbone.Collection.extend({model:Iframework.PortIn})}),$(function(){var e='<div class="portshown portshown-in"><span class="hole hole-in hole-<%= type_class %> icon-login"></span><span class="label"><%= name %></span></div><span class="plugend plugend-in plugend-<%= type_class %>"></span>';Iframework.PortInView=Iframework.PortView.extend({tagName:"div",className:"port",portInTemplate:_.template(e),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","submit .manualinput":"manualinput","click .publish-port":"publishPort"},render:function(){this.$el.html(this.portInTemplate(this.model.toJSON())),this.$el.addClass("port-in"),this.$(".hole").draggable({helper:function(){return $('<span class="holehelper holehelper-out" />')}}),this.$(".plugend").draggable({helper:function(){return $('<span class="plugendhelper plugendhelper-in" />')}}),this.$(".hole").data({model:this.model});var e="",t=this.model.get("type_class");e="all"===t||"bang"===t?".hole-out, .plugend-in":".hole-out.hole-all, .hole-out.hole-"+t+", .plugend-in.plugend-all, .plugend-in.plugend-"+t,"string"===t&&(e+=", .hole-out.hole-int, .hole-out.hole-float, .plugend-in.plugend-int, .plugend-in.plugend-float"),("int"===t||"float"===t||"number"===t)&&(e+=", .hole-out.hole-int, .hole-out.hole-float, .hole-out.hole-number, .plugend-in.plugend-int, .plugend-in.plugend-float, .plugend-in.plugend-number"),this.$el.droppable({hoverClass:"drophover",accept:e}),this.$(".plugend").hide(),this.$(".portshown").disableSelection()},dragstart:function(e,t){this.model.node.parentGraph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var i=new Iframework.EdgeView;Iframework.edgePreview=i,this.drag(e,t),this.$(".plugend").show(),e.stopPropagation()},drag:function(e,t){if(Iframework.edgePreview){var i=t.offset.left+Iframework.shownGraph.view.el.scrollLeft,n=t.offset.top+8+Iframework.shownGraph.view.el.scrollTop,r=this.portOffsetLeft(),o=this.portOffsetTop(),s={fromX:this.model.isIn?i-2:r,fromY:this.model.isIn?n:o,toX:this.model.isIn?r:i+20,toY:this.model.isIn?o:n};Iframework.edgePreview.setPositions(s),Iframework.edgePreview.redraw()}e.stopPropagation()},dragstop:function(e){this.model.node.parentGraph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=void 0,1>this.relatedEdges().length&&this.$(".plugend").hide(),e.stopPropagation()},drop:function(e,t){if(this.armDelete)this.armDelete=!1;else{var i=$(t.draggable).data("model"),n=this.model,r=this.model.isIn?i:n,o=this.model.isIn?n:i,s=new Iframework.Edge({source:[r.node.id,r.id],target:[o.node.id,o.id],parentGraph:this.model.parentNode.parentGraph});Iframework.edgePreview&&(s._color=Iframework.edgePreview._color),s.parentGraph.addEdge(s)&&s.connect()}e.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var e,t=0;return _.each(this.relatedEdges(),function(i){i.view._z>=t&&(t=i.view._z,e=i)},this),e},unplugstart:function(e){this.model.node.parentGraph.view.maskFrames();var t=this.topConnectedEdge();if(!t)return!1;this.unpluggingEdge=t,this.unpluggingEdge.view.dim(),1===this.relatedEdges().length&&this.$(".plugend").hide();var i=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",i),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var n=new Iframework.EdgeView;n.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=n,this.armDelete=!0,e.stopPropagation()},unplugdrag:function(e,t){if(Iframework.edgePreview&&this.unpluggingEdge){var i=t.offset.left+Iframework.shownGraph.view.el.scrollLeft,n=t.offset.top+6+Iframework.shownGraph.view.el.scrollTop,r=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,o=r.portOffsetLeft(),s=r.portOffsetTop(),a={fromX:this.model.isIn?o:i-2,fromY:this.model.isIn?s:n,toX:this.model.isIn?i+20:o,toY:this.model.isIn?n:s};Iframework.edgePreview.setPositions(a),Iframework.edgePreview.redraw()}e.stopPropagation()},unplugstop:function(e,t){this.armDelete&&this.unpluggingEdge?this.model.parentGraph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(e,t)},clickhole:function(e){$("div.edge-edit").remove();var t=this.$(".hole");this.model.isIn;var i=this.model.get("name"),n=this.popupTemplate(this.model.toJSON());n=$(n),this.$el.append(n),n.children("button.close").click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null});var r=this.model.get("type").substring(0,3),o=!1,s=$("<form />").attr({id:this.model.node.id+"_"+this.model.get("name"),"class":"manualinput",novalidate:""});if("int"===r||"num"===r||"flo"===r)o=!0,s.append($("<input />").attr({value:this.model.node.get("state")[this.model.get("name")],title:'use equations like "=x*100" to change all incoming values'}));else if("col"===r){o=!0;var a=this.model.node.get("state")[this.model.get("name")],l=$("<input />").attr({type:"text",maxlength:140,value:a,style:"width: 90%"});s.append(l);var h=this;l.spectrum({showInitial:!0,showInput:!0,showAlpha:!0,showPalette:!0,palette:[Iframework.wireColors,["red","green","blue","purple","cyan","magenta","yellow"],["black","#333","#666","#999","#AAA","#CCC","white"]],showSelectionPalette:!0,localStorageKey:"iframework.settings.colorPalette",change:function(e){var t=e.toRgbString();l.val(t),h.model.node.receive(i,t),h.model.node.setValue(i,t)},hide:function(){l.show()},beforeShow:function(){l.spectrum("set",l.val()),l.hide()}}).show()}else if("str"===r)o=!0,s.append($("<input />").attr({type:"text",maxlength:t.data("max"),value:this.model.node.get("state")[this.model.get("name")]}));else if("arr"===r){o=!0;var d=this.model.node.get("state")[this.model.get("name")];"array"!==Iframework.util.type(d)&&(d=[]);for(var u="",c=0;d.length>c;c++)u+=(c>0?", ":"")+d[c];s.append($("<input />").attr({type:"text",value:u}))}else if("boo"===r){o=!0;var p=this.model.node.get("state")[this.model.get("name")];p=Boolean(p)&&"false"!==p,s.append($("<input />").attr({type:"checkbox",checked:p}))}else"ban"===r&&(s.append("<label>Send bang:</label> "),o=!0);o&&(s.append($("<button></button>").attr({type:"submit","class":"send icon-ok",title:"send value to module"})),n.append(s)),$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(n.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(e){var t=this.edgeEditTemplate(e.view);n.append(t)},this)),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),e.stopPropagation()},manualinput:function(){var e,t=this.model.get("name"),i=this.model.get("type"),n=i.substring(0,3),r=!0;if(this.$(".manualinput").children("input")&&(e=this.$(".manualinput").children("input").val()),this.$(".manualinput").children("input:checkbox").length>0&&(e=this.$(".manualinput").children("input:checkbox").is(":checked")?!0:!1),("int"===i||"number"===i||"float"===i)&&("string"==typeof e&&"="===(""+e).substr(0,1)||("int"===i?e=parseInt(e,10):("number"===i||"float"===i)&&(e=parseFloat(e)))),"arr"===n)try{e=JSON.parse("["+e+"]")}catch(o){return!1}return void 0===e&&(e="!",r=!1),r&&this.model.node.setValue(t,e),this.model.node.receive(t,e),!1},disconnect:function(e){var t=this.model.parentGraph.get("edges").getByCid($(e.target).parents(".edge-edit-item").attr("id"));t&&this.model.parentGraph.removeEdge(t),$("div.edge-edit").remove(),Iframework.selectedPort=null,e.stopPropagation()},_relatedEdges:null,relatedEdges:function(){return null===this._relatedEdges&&(this._relatedEdges=this.model.parentGraph.get("edges").filter(function(e){return e.Source===this.model||e.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var e=this.topConnectedEdge();e&&e.view&&e.view.highlight()}},highlight:function(){var e=this.$(".plugend");e.addClass("highlight"),setTimeout(function(){e.removeClass("highlight")},1e3)},publishPort:function(){var e=this.model.parentNode.parentGraph.addNode({src:"meemoo:subgraph/input",x:100,y:100,w:80,h:60,state:{label:this.model.id},parentGraph:this.model.parentNode.parentGraph}),t=new Iframework.Edge({source:[e.id,"data"],target:[this.model.parentNode.id,this.model.id],parentGraph:this.model.parentNode.parentGraph});this.model.parentNode.parentGraph.addEdge(t)}})}),$(function(){Iframework.PortOut=Iframework.Port.extend({defaults:{name:"",type:"",description:"","default":null},initializeView:function(){return this.view=new Iframework.PortOutView({model:this}),this.view}}),Iframework.PortsOut=Backbone.Collection.extend({model:Iframework.PortOut})}),$(function(){var e='<div class="portshown portshown-out"><span class="label"><%= name %></span><span class="hole hole-out hole-<%= type_class %> icon-logout"></span></div><span class="plugend plugend-out plugend-<%= type_class %>"></span>';Iframework.PortOutView=Iframework.PortView.extend({tagName:"div",className:"port",portOutTemplate:_.template(e),events:{mousedown:"highlightEdge","click .hole":"clickhole","dragstart .hole":"dragstart","drag .hole, .holehelper":"drag","dragstop .hole, .holehelper":"dragstop","dragstart .plugend":"unplugstart","drag .plugend":"unplugdrag","dragstop .plugend":"unplugstop",drop:"drop","click .disconnect":"disconnect","click .publish-port":"publishPort"},render:function(){this.$el.html(this.portOutTemplate(this.model.toJSON())),this.$el.addClass("port-out"),this.$(".hole").draggable({helper:function(){return $('<span class="holehelper holehelper-in" />')}}),this.$(".plugend").draggable({helper:function(){return $('<span class="plugendhelper plugendhelper-out" />')}}),this.$(".hole").data({model:this.model});var e="",t=this.model.get("type_class");"all"===t?e=".hole-in, .plugend-out":(e=".hole-in.hole-all, .hole-in.hole-"+t+", .plugend-out.plugend-all, .plugend-out.plugend-"+t,e+=", .hole-in.hole-bang, .plugend-out.plugend-string"),("int"===t||"float"===t||"number"===t)&&(e+=", .hole-in.hole-string, .plugend-out.plugend-string",e+=", .hole-in.hole-int, .hole-in.hole-float, .hole-out.hole-number, .plugend-out.plugend-int, .plugend-out.plugend-float, .plugend-out.plugend-number"),this.$el.droppable({hoverClass:"drophover",accept:e}),this.$(".plugend").hide(),this.$(".portshown").disableSelection()},dragstart:function(e,t){this.model.node.parentGraph.view.maskFrames(),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole").addClass("fade"),$("div.ports-"+(this.model.isIn?"out":"in")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var i=new Iframework.EdgeView;Iframework.edgePreview=i,this.drag(e,t),this.$(".plugend").show(),e.stopPropagation()},drag:function(e,t){if(Iframework.edgePreview){var i=t.offset.left+Iframework.shownGraph.view.el.scrollLeft,n=t.offset.top+8+Iframework.shownGraph.view.el.scrollTop,r=this.portOffsetLeft(),o=this.portOffsetTop(),s={fromX:this.model.isIn?i-2:r,fromY:this.model.isIn?n:o,toX:this.model.isIn?r:i+20,toY:this.model.isIn?o:n};Iframework.edgePreview.setPositions(s),Iframework.edgePreview.redraw()}e.stopPropagation()},dragstop:function(e){this.model.node.parentGraph.view.unmaskFrames(),$(".hole").removeClass("fade highlight"),Iframework.edgePreview.remove(),Iframework.edgePreview=void 0,1>this.relatedEdges().length&&this.$(".plugend").hide(),e.stopPropagation()
},drop:function(e,t){if(this.armDelete)this.armDelete=!1;else{var i=$(t.draggable).data("model"),n=this.model,r=this.model.isIn?i:n,o=this.model.isIn?n:i,s=new Iframework.Edge({source:[r.node.id,r.id],target:[o.node.id,o.id],parentGraph:this.model.parentNode.parentGraph});Iframework.edgePreview&&(s._color=Iframework.edgePreview._color),s.parentGraph.addEdge(s)&&s.connect()}e.stopPropagation()},unpluggingEdge:null,armDeleteTimeout:null,armDelete:!1,topConnectedEdge:function(){var e,t=0;return _.each(this.relatedEdges(),function(i){i.view&&i.view._z>=t&&(t=i.view._z,e=i)},this),e},unplugstart:function(e){this.model.node.parentGraph.view.maskFrames();var t=this.topConnectedEdge();if(!t)return!1;this.unpluggingEdge=t,this.unpluggingEdge.view.dim(),1===this.relatedEdges().length&&this.$(".plugend").hide();var i=this.model.isIn?this.unpluggingEdge.Source:this.unpluggingEdge.Target;this.$(".plugend").data("model",i),$("div.ports-"+(this.model.isIn?"in":"out")+" span.hole-"+this.model.get("type_class")).addClass("highlight");var n=new Iframework.EdgeView;n.setColor(this.unpluggingEdge.view._color),Iframework.edgePreview=n,this.armDelete=!0,e.stopPropagation()},unplugdrag:function(e,t){if(Iframework.edgePreview&&this.unpluggingEdge){var i=t.offset.left+Iframework.shownGraph.view.el.scrollLeft,n=t.offset.top+6+Iframework.shownGraph.view.el.scrollTop,r=this.model.isIn?this.unpluggingEdge.Source.view:this.unpluggingEdge.Target.view,o=r.portOffsetLeft(),s=r.portOffsetTop(),a={fromX:this.model.isIn?o:i-2,fromY:this.model.isIn?s:n,toX:this.model.isIn?i+20:o,toY:this.model.isIn?n:s};Iframework.edgePreview.setPositions(a),Iframework.edgePreview.redraw()}e.stopPropagation()},unplugstop:function(e,t){this.armDelete&&this.unpluggingEdge?this.model.parentGraph.removeEdge(this.unpluggingEdge):(this.$(".plugend").show(),this.unpluggingEdge.view.undim()),this.armDelete=!1,this.unpluggingEdge=null,this.dragstop(e,t)},clickhole:function(e){$("div.edge-edit").remove(),this.$(".hole"),this.model.isIn,this.model.get("name");var t=this.popupTemplate(this.model.toJSON());t=$(t),this.$el.append(t),t.children("button.close").click(function(){$("div.edge-edit").remove(),Iframework.selectedPort=null}),this.model.get("type").substring(0,3),$("#select_"+this.model.id).button({icons:{primary:"ui-icon-power"}}),this.relatedEdges().length>0&&(t.append("<h2>disconnect</h2>"),_.each(this.relatedEdges(),function(e){var i=this.edgeEditTemplate(e.view);t.append(i)},this)),this.model.get("options")&&this.model.get("options").length>0&&this.$("input").autocomplete({minLength:0,source:this.model.get("options")}),e.stopPropagation()},disconnect:function(e){var t=this.model.parentGraph.get("edges").getByCid($(e.target).parents(".edge-edit-item").attr("id"));t&&this.model.parentGraph.removeEdge(t),$("div.edge-edit").remove(),Iframework.selectedPort=null,e.stopPropagation()},_relatedEdges:null,relatedEdges:function(){return null===this._relatedEdges&&(this._relatedEdges=this.model.parentGraph.get("edges").filter(function(e){return e.Source===this.model||e.Target===this.model},this),this._relatedEdges.length>=1?this.$(".plugend").show():this.$(".plugend").hide()),this._relatedEdges},resetRelatedEdges:function(){this._relatedEdges=null,this.relatedEdges()},highlightEdge:function(){if(this.relatedEdges().length>0){var e=this.topConnectedEdge();e&&e.view&&e.view.highlight()}},highlight:function(){var e=this.$(".plugend");e.addClass("highlight"),setTimeout(function(){e.removeClass("highlight")},1e3)},publishPort:function(){var e=this.model.parentNode.parentGraph.addNode({src:"meemoo:subgraph/output",x:500,y:500,w:80,h:60,state:{label:this.model.id},parentGraph:this.model.parentNode.parentGraph}),t=new Iframework.Edge({source:[this.model.parentNode.id,this.model.id],target:[e.id,"data"],parentGraph:this.model.parentNode.parentGraph});this.model.parentNode.parentGraph.addEdge(t)}})}),$(function(){Iframework.Module=Backbone.Model.extend({defaults:{src:"",info:{}},initialize:function(){var e=this.get("src").split(":");this.isNative="meemoo"===e[0],this.isNative&&(this.groupAndName=e[1].split("/"))},initializeView:function(){return this.view||(this.view=new Iframework.ModuleView({model:this})),this.view},toJSON:function(){return{src:this.get("src"),info:this.get("info")}}}),Iframework.Modules=Backbone.Collection.extend({model:Iframework.Module,findOrAdd:function(e){var t;return t=this.find(function(t){return t.get("src")===e.get("src")}),t||(t=new Iframework.Module({node:e}),this.add(t)),t}})}),$(function(){var e='<div class="addnode button module-icon" title="<%= info.description %>"></div><h2 class="title" title="<%= src %>"><%= info.title %></h2>';Iframework.ModuleView=Backbone.View.extend({tagName:"div",className:"library-module",template:_.template(e),events:{"click .addnode":"addNode","dragstart .addnode":"dragStart","dragstop .addnode":"dragStop"},initialize:function(){this.render();var e=this;return this.$(".addnode").data({module:this.model}).draggable({helper:function(){var t=$('<div class="addnode-drag-helper module-icon" />').data({"meemoo-drag-type":"library-module"});return e.model.isNative&&t.addClass("module-icon-"+e.model.groupAndName[0]+"-"+e.model.groupAndName[1]),$(".app").append(t),t}}),this.model.isNative&&this.$(".addnode").addClass("module-icon-"+this.model.groupAndName[0]+"-"+this.model.groupAndName[1]),this},render:function(){this.$el.html(this.template(this.model.toJSON()))},addNode:function(e){Iframework.$(".addbyurlinput").val(this.model.get("src")),Iframework.addByUrl(e)},dragAddNode:function(e){e.src=this.model.get("src"),Iframework.shownGraph.addNode(e)},dragStart:function(){Iframework.shownGraph.view.maskFrames()},dragStop:function(){Iframework.shownGraph.view.unmaskFrames()}})}),$(function(){Iframework.Edge=Backbone.Model.extend({defaults:{source:[0,"default"],target:[0,"default"]},initialize:function(){this.parentGraph=this.get("parentGraph")},initializeView:function(){return this.view=new Iframework.EdgeView({model:this}),this.view},Source:null,Target:null,connectTryCount:5,connected:!1,connect:function(){try{this.Source=this.parentGraph.get("nodes").get(this.get("source")[0]).Outputs.get(this.get("source")[1]),this.Target=this.parentGraph.get("nodes").get(this.get("target")[0]).Inputs.get(this.get("target")[1])}catch(e){if(console.warn("Edge source or target port not found, try #"+this.connectTryCount+": "+(""+this)),this.connectTryCount>0){this.connectTryCount--;var t=this;_.delay(function(){t.connect()},1e3)}return!1}return this.Source&&this.Target?(this.Source.connect(this),this.Target.connect(this),this.Source.node.receive({connect:{source:[this.Source.node.id,this.Source.id],target:[this.Target.node.id,this.Target.id]}}),this.parentGraph.view&&this.parentGraph.view.addEdge(this),this.Target.node.view&&this.Target.node.view.Native&&this.Target.node.view.Native.connectEdge(this),this.connected=!0,this.Source.node.on("send:"+this.Source.id,this.send,this),this):!1},send:function(e){this.Target.node.receive(this.Target.id,e)},disconnect:function(){this.Source&&this.Target&&(this.Source.disconnect(this),this.Target.disconnect(this),this.Source.node.receive({disconnect:{source:[this.Source.node.id,this.Source.id],target:[this.Target.node.id,this.Target.id]}}),this.Target.node.view&&this.Target.node.view.Native&&this.Target.node.view.Native.disconnectEdge(this)),this.view&&this.view.remove(),this.Source.node.off("send:"+this.Source.id,this.send,this),this.connected=!1},remove:function(){this.parentGraph.removeEdge(this)},toJSON:function(){return{source:this.get("source"),target:this.get("target")}},toString:function(){return this.get("source")[0]+":"+this.get("source")[1]+"->"+this.get("target")[0]+":"+this.get("target")[1]}}),Iframework.Edges=Backbone.Collection.extend({model:Iframework.Edge})}),$(function(){Iframework.EdgeView=Backbone.View.extend({tagName:"div",className:"edge",positions:null,graphSVGElement:null,elementGroup:null,elementWire:null,elementShadow:null,isPreview:!1,initialize:function(){this.graphSVGElement=this.model?this.model.parentGraph.view.edgesSvg:Iframework.shownGraph.view.edgesSvg,this.positions={fromX:0,fromY:0,toX:0,toY:0},this.model||(this.isPreview=!0),this.model&&this.model._color&&(this._color=this.model._color),this.render(),this.model&&(this._z=this.model.parentGraph.edgeCount++,$(this.elementWire).data({model:this.model}).click(function(e){$(e.target).data("model").view.click(e)}),this.model.Source&&this.model.Source.parentNode.on("change:x change:y change:w change:h",this.redraw,this),this.model.Target&&this.model.Target.parentNode.on("change:x change:y",this.redraw,this))},render:function(){return this.calcPositions(),this.elementGroup=this.makeSVG("g",{transform:"translate("+this.svgX()+","+this.svgY()+")","class":"wire-group"+(this.isPreview?" preview":"")}),this.elementShadow=this.makeSVG("path",{"class":"wire-shadow",d:this.svgPathShadow()}),this.elementWire=this.makeSVG("path",{"class":"wire",d:this.svgPath(),stroke:this.color()}),this.elementGroup.appendChild(this.elementShadow),this.elementGroup.appendChild(this.elementWire),this.graphSVGElement.appendChild(this.elementGroup),this.model&&(this.model.Source.view.$(".plugend").show(),this.model.Target.view.$(".plugend").show(),this.model.parentGraph.view.resizeEdgeSVG()),this},redraw:function(){this.calcPositions(),$(this.elementGroup).attr("transform","translate("+this.svgX()+", "+this.svgY()+")"),$(this.elementWire).attr("d",this.svgPath()),$(this.elementShadow).attr("d",this.svgPathShadow()),this.model?this.model.parentGraph.view.resizeEdgeSVG():Iframework.shownGraph.view.resizeEdgeSVG()},remove:function(){$(this.elementGroup).remove()},setPositions:function(e){this.positions=e},calcPositions:function(){if(this.model){var e=this.model.get("source")[1],t=this.model.get("target")[1];this.positions.fromX=this.model.Source.view.portOffsetLeft("out",e),this.positions.fromY=this.model.Source.view.portOffsetTop("out",e),this.positions.toX=this.model.Target.view.portOffsetLeft("in",t),this.positions.toY=this.model.Target.view.portOffsetTop("in",t)}},svgX:function(){return Math.min(this.positions.toX,this.positions.fromX)-50},svgY:function(){return Math.min(this.positions.toY,this.positions.fromY)-25},svgW:function(){return Math.abs(this.positions.toX-this.positions.fromX)+100},svgH:function(){return Math.abs(this.positions.toY-this.positions.fromY)+50},pathStraight:35,pathCurve:60,svgPath:function(){var e=this.positions.fromX-this.svgX(),t=this.positions.fromY-this.svgY(),i=this.positions.toX-this.svgX(),n=this.positions.toY-this.svgY();return"M "+e+" "+t+" L "+(e+this.pathStraight)+" "+t+" C "+(e+this.pathCurve)+" "+t+" "+(i-this.pathCurve)+" "+n+" "+(i-this.pathStraight)+" "+n+" L "+i+" "+n},svgPathShadow:function(){var e=this.positions.fromX-this.svgX(),t=this.positions.fromY-this.svgY()+1,i=this.positions.toX-this.svgX(),n=this.positions.toY-this.svgY()+1;return"M "+e+" "+t+" L "+(e+this.pathStraight)+" "+t+" C "+(e+this.pathCurve)+" "+t+" "+(i-this.pathCurve)+" "+n+" "+(i-this.pathStraight)+" "+n+" L "+i+" "+n},color:function(){return this._color?this._color:this.model?(this._color=Iframework.getWireColor(),this._color):Iframework.wireColors[Iframework.wireColorIndex]},setColor:function(e){this._color=e,$(this.elementWire).attr("stroke",e)},label:function(){return this.model.get("source")[0]+":"+this.model.get("source")[1]+'<span class="wiresymbol" style="color:'+this._color+'">&rarr;</span>'+this.model.get("target")[0]+":"+this.model.get("target")[1]},makeSVG:function(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg",e);for(var n in t)"xlink:href"===n?i.setAttributeNS("http://www.w3.org/1999/xlink","href",t[n]):i.setAttribute(n,t[n]);return i},dim:function(){$(this.elementGroup).attr("opacity",.2)},undim:function(){$(this.elementGroup).attr("opacity",1)},click:function(){this._z<this.model.parentGraph.edgeCount-1&&(this.graphSVGElement.appendChild(this.elementGroup),this._z=this.model.parentGraph.edgeCount++),this.highlight()},highlight:function(){var e=$(this.elementShadow);e.attr("class","wire-shadow highlight"),setTimeout(function(){e.attr("class","wire-shadow")},1e3),this.model.Source.view&&this.model.Source.view.highlight(),this.model.Target.view&&this.model.Target.view.highlight()}})}),$(function(){var e=Backbone.Router.extend({routes:{"example/:url":"loadExample","new":"newBlank","local/:url":"loadLocal","gist/https://gist.github.com/:user/:id":"loadGistUgly","gist/:id":"loadGist","*path":"default"},loadExample:function(e){Iframework.loadExample(e)},loadGistUgly:function(e){this.navigate("gist/"+e,{replace:!0}),this.loadGist(e)},loadLocal:function(e){Iframework.loadLocal(e)},loadGist:function(e){Iframework.loadFromGistId(e)},newBlank:function(){Iframework.newBlank()},"default":function(){}});Iframework.router=new e,Backbone.history.start()}),$(function(){var e='<div class="info" />';Iframework.NativeNodes.image=Iframework.NodeBoxNativeView.extend({template:_.template(e),canvas:null,context:null,initializeCategory:function(){var e=this;this.model.view.$("button.remove").after($('<button title="popout" type="button" class="popout icon-popup"></button>').click(function(){e.popout()})),this.canvas=document.createElement("canvas"),this.canvas.width=10,this.canvas.height=10,this.context=this.canvas.getContext("2d"),$(this.canvas).attr({"class":"canvas",id:"canvas-"+this.model.id}).css({maxWidth:"100%",cursor:"pointer"}).draggable({cursor:"pointer",cursorAt:{top:-10,left:-10},helper:function(){var t=$('<div class="drag-image"><h2>Copy this</h2></div>').data({"meemoo-drag-type":"canvas","meemoo-source-node":e});return $(document.body).append(t),_.delay(function(){e.dragCopyCanvas(t)},100),t}});var t;for(var i in this.inputs)if("image"===this.inputs[i].type){t=i;break}t&&(this.$el.append('<div class="drop-indicator"><p class="icon-login">input '+t+"</p></div>"),this.$el.droppable({accept:".canvas, .meemoo-plugin-images-thumbnail",tolerance:"pointer",hoverClass:"drop-hover",activeClass:"drop-active",greedy:!0}),this.$el.on("drop",{self:this,inputName:t},Iframework.util.imageDrop)),this.$el.prepend(this.canvas)},dragCopyCanvas:function(e){if(e){var t=document.createElement("canvas");t.width=this.canvas.width,t.height=this.canvas.height,t.getContext("2d").drawImage(this.canvas,0,0),e.data("meemoo-drag-canvas",t),e.append(t)}},scale:function(){return this.$(".canvas").width()/this.canvas.width},outputs:{image:{type:"image"}},_smoothing:!0,inputsmoothing:function(e){this._smoothing=e,this.context.webkitImageSmoothingEnabled=e,this.context.mozImageSmoothingEnabled=e},exportImage:function(){try{var e=this.canvas.toDataURL();window.open(e)}catch(t){}},popout:function(){if(this.w)return this.popin(),!1;this.localCanvas=this.canvas,this.localContext=this.context,this.w=window.open("","meemooRemoteWindow","menubar=no,location=no,resizable=yes,scrollbars=no,status=no");var e=this;return this.w.addEventListener("unload",function(){e.popin()}),Iframework.popoutModule&&Iframework.popoutModule!==this&&Iframework.popoutModule.popin(),Iframework.popoutModule=this,this.w.document.body.innerHTML="",this.canvas=this.w.document.createElement("canvas"),this.canvas.width=this.localCanvas.width,this.canvas.height=this.localCanvas.height,this.context=this.canvas.getContext("2d"),this.context.drawImage(this.localCanvas,0,0),this.w.document.body.appendChild(this.canvas),this.w.document.body.style.backgroundColor="black",this.w.document.body.style.overflow="hidden",this.w.document.body.style.margin="0px",this.w.document.body.style.padding="0px",this.w.document.title="meemoo.org",this.canvas.style.position="absolute",this.canvas.style.top="0px",this.canvas.style.left="0px",this.canvas.style.width="100%",this.inputsmoothing(this._smoothing),!1},popin:function(){return this.w&&(this.w=null),this.canvas=this.localCanvas,this.context=this.localContext,this.inputsmoothing(this._smoothing),!1}})}),$(function(){var e=$('<div><div class="sourceedit"><textarea /></div><div class="controls"><button class="button sourcerefresh icon-cw" title="refresh the source code">refresh</button><button class="button sourcecompress icon-bag" title="refresh and compress the source code into one line">compress</button><button class="button sourceapply icon-ok" title="reloads the app">apply changes</button></div></div>'),t=e.find("textarea");Iframework.addMenu("source",e,"icon-cog"),Iframework.on("change",function(){if(Iframework.graph&&Iframework.$(".menu-source").is(":visible")){var e=t.prop("scrollTop");t.val(JSON.stringify(Iframework.graph.toJSON(),null,"  ")),t.scrollTop(e)}});var i=function(){t.val(JSON.stringify(Iframework.graph,null,"  "))};e.find(".sourcerefresh").click(i),Iframework.on("showmenu:source",i);var n=function(){t.val(JSON.stringify(Iframework.graph,null,""))};e.find(".sourcecompress").click(n);var r=function(){var e;try{e=JSON.parse(t.val())}catch(n){return!1}if(e){var r=Iframework.loadGraph(e);Iframework._loadedLocalApp=null,i(),r.trigger("change")}return!1};e.find(".sourceapply").click(r)}),$(function(){var e=$('<div><div class="controls"><form class="addbyurl"><input class="addbyurlinput" name="addbyurlinput" placeholder="search or url" type="text" /><button class="addbyurlsubmit icon-ok" type="submit">load</button></form></div><div class="listing"></div></div>');Iframework.addMenu("library",e,"icon-plus"),Iframework.loadLibrary=function(t){var i=[],n=$("<div></div>");for(var r in t)if(t.hasOwnProperty(r)){var o=$('<div class="library-section"></div>');o.append($('<h3><a href="#">'+r+"</a></h3>"));for(var s=$("<div></div>"),a=t[r],l=0;a.length>l;l++){var h=new Iframework.Module(a[l]);h.initializeView(),s.append(h.view.$el);var d={value:h.get("src"),label:h.get("info").title+" - "+h.get("info").description+" - "+h.get("src"),title:h.get("info").title,description:h.get("info").description+" - "+h.get("src")};i.push(d)}o.append(s),n.append(o)}e.find(".listing").append(n),n.children(".library-section").accordion({animate:!1,header:"h3",heightStyle:"content",collapsible:!0,active:!1}),e.find(".addbyurlinput").autocomplete({minLength:1,source:i,select:function(){_.defer(function(){Iframework.addByUrl()})}}).data("ui-autocomplete")._renderItem=function(e,t){return $("<li>").append('<a><span style="font-size:120%;">'+t.title+"</span><br>"+t.description+"</a>").appendTo(e)}};var t=Iframework.addByUrl=function(){var e=Iframework.$(".addbyurlinput");e.blur();var t=e.val();if(""!==t){var i=Iframework.$(".graph");Iframework.shownGraph.addNode({src:t,x:Math.floor(i.scrollLeft()+i.width()/2)-100,y:Math.floor(i.scrollTop()+i.height()/2)-100}),e.val("").attr("placeholder","loading..."),window.setTimeout(function(){e.attr("placeholder","search or url")},1e3)}return!1};e.find(".addbyurl").submit(function(){return t(),!1})}),$(function(){var e="AaqPpE9LORQel03S9cCl7z",t="http://i.meemoo.me/";window.URL||(window.URL=window.webkitURL||window.msURL||window.oURL||!1);var i=$('<div class="meemoo-plugin-images"><div class="listing"><h2>Local images (not saved)</h2><span style="position:absolute;width:0px;overflow:hidden;"><input type="file" class="file-input-local" accept="image/*" multiple /></span><button class="localfile icon-camera" title="Not public. From computer (or mobile camera).">Choose local image</button> from computer or mobile camera<div class="image-drop local-drop"><div class="drop-indicator"><p>drag image here to hold it</p></div></div><div class="thumbnails local-listing"></div><h2>Meemoo.me images (public)</h2><span style="position:absolute;width:0px;overflow:hidden;"><input type="file" class="file-input-public" accept="image/*" /></span><button disabled class="publicfile icon-camera" title="Import from computer (or mobile camera).">Upload</button><button disabled class="publicfile-service icon-globe-1" title="Upload image to Meemoo from computer, URL, Flickr, Google, Dropbox...">Import from Flickr, Dropbox, etc.</button><div class="info"></div><div class="image-drop public-drop"><div class="drop-indicator"><p class="icon-globe-1">drag image here to save to meemoo.me</p></div></div><div class="thumbnails public-listing"></div></div></div>');Iframework.addMenu("images",i,"icon-picture");var n=i.find(".info"),r=function(e){n.text(e)};yepnope({load:"http://api.filepicker.io/v1/filepicker.js",complete:function(){window.filepicker?(filepicker.setKey(e),i.find(".publicfile, .publicfile-service").prop("disabled",!1)):r("Offline or image service not available.")}}),Iframework.$(".show-images").droppable({accept:".canvas, .image",tolerance:"pointer",activeClass:"drop-indicator",over:function(){$(this).trigger("click")}}),i.find(".image-drop").droppable({accept:".canvas",tolerance:"pointer",hoverClass:"drop-hover",activeClass:"drop-active",greedy:!0}),i.find(".public-drop").droppable({accept:".canvas, .image"}),i.find(".local-drop").on("drop",function(e,t){var i=t.helper.data("meemoo-drag-canvas");if(!i)return!1;var n=o(i);l.append(n)});var o=function(e){var t=$('<div class="meemoo-plugin-images-thumbnail canvas">').append(e).draggable({cursor:"pointer",cursorAt:{top:-10,left:-10},helper:function(){var t=$('<div class="drag-image"><h2>Copy this</h2></div>').data({"meemoo-drag-type":"canvas","meemoo-source-image":e});return $(document.body).append(t),_.delay(function(){s(t)},100),t}});return t},s=function(e){if(e){var t=e.data("meemoo-source-image"),i=document.createElement("canvas");i.width=t.naturalWidth?t.naturalWidth:t.width,i.height=t.naturalHeight?t.naturalHeight:t.height,i.getContext("2d").drawImage(t,0,0),e.data("meemoo-drag-canvas",i),e.append(i)}},a=i.find(".file-input-local"),l=i.find(".local-listing");a.change(function(e){for(var t=e.target.files,i=0;t.length>i;i++){var n=new Image;n.src=window.URL.createObjectURL(t[i]);var r=o(n);l.append(r)}}),i.find(".localfile").click(function(){a.trigger("click")});var h=function(e){for(var t=0;e.length>t;t++){var i={main:e[t]},n=new Iframework.plugins.images.GalleryImage({files:i});p.add(n),n.save()}},d=i.find(".public-listing");i.find(".publicfile-service").click(function(){return window.filepicker?(filepicker.pickAndStore({mimetype:"image/*",multiple:!0,maxSize:5242880},{location:"S3",path:"v1/in/",access:"public"},h),void 0):(r("Image service not yet available."),!1)});var u=i.find(".file-input-public");u.change(function(e){return window.filepicker?(e.target.files.length>0&&(r("Uploading..."),filepicker.store(e.target,{location:"S3",path:"v1/in/",access:"public"},function(e){var t=[];t.push(e),h(t)},function(){r("Upload error :-(")},function(e){r(e+"% uploaded.")})),void 0):(r("Image service not yet available."),!1)}),i.find(".publicfile").click(function(){return window.filepicker?(u.trigger("click"),void 0):(r("Image service not yet available."),!1)}),i.find(".public-drop").on("drop",function(e,t){if(!window.filepicker)return r("Image service not available."),!1;var i=t.helper.data("meemoo-drag-canvas"),n=t.helper.data("meemoo-source-image");if(!i&&!n)return!1;var o,s;if(i){try{s=i.toDataURL().split(",",2)[1]}catch(a){return r('Not able to get image data. Right-click "Save as..." or take a screenshot.'),!1}o={mimetype:"image/png",location:"S3",path:"v1/out/",filename:"meemoo.png",access:"public",base64decode:!0}}else if(n){if("data"!==n.src.split(":")[0])return!1;var l=n.src.split(",",2),h=l[0].split(":")[1].split(";")[0],d=h.split("/")[1];s=l[1],o={mimetype:h,location:"S3",path:"v1/out/",filename:"meemoo."+d,access:"public",base64decode:!0}}return s&&o?(r("Uploading..."),filepicker.store(s,o,function(e){var t={main:e},i=new Iframework.plugins.images.GalleryImage({files:t});p.add(i),i.save(),r("Upload done :-)"),_.delay(function(){r("")},2e3)},function(){r("Upload error :-(")},function(e){r(e+"% uploaded.")}),void 0):!1}),Iframework.plugins.images={},Iframework.plugins.images.GalleryImage=Backbone.Model.extend({initialize:function(){this.mainsrc=t+this.get("files").main.key;var e=this.get("files").thumb;if(e&&e.key)this.thumbsrc=t+e.key;else{this.thumbsrc=this.mainsrc;var i=this;_.delay(function(){i.makeThumb()},3e3)}this.initializeView()},initializeView:function(){return this.view||(this.view=new Iframework.plugins.images.GalleryImageView({model:this})),this.view},makeThumb:function(){var e=this,t=this.get("files").main;t&&window.filepicker&&filepicker.convert(t,{fit:"crop",format:"jpg",quality:80,width:100,height:100},{location:"S3",path:"v1/thumbs/",access:"public"},function(t){var i=e.get("files");i.thumb=t,e.save()},function(){})},toJSON:function(){return{id:this.id,files:this.get("files")}}}),Iframework.plugins.images.GalleryImages=Backbone.Collection.extend({model:Iframework.plugins.images.GalleryImage,localStorage:new Backbone.LocalStorage("GalleryImages")});var c='<img crossorigin="anonymous" title="drag to graph or image node" /><div class="controls"><a class="link button icon-link" title="Open image in new window" target="_blank"></a><button class="export-public icon-export" title="Save straight to Flickr, Dropbox, Google, Facebook..."></button><button class="delete icon-trash" title="Delete image"></button></div>';Iframework.plugins.images.GalleryImageView=Backbone.View.extend({tagName:"div",className:"meemoo-plugin-images-thumbnail",template:_.template(c),events:{"click .export-public":"exportPublic","click .delete":"destroyModel"},initialize:function(){this.$el.html(this.template(this.model.toJSON()));var e=this.model.mainsrc;this.$(".link").attr("href",e);var t=this.$("img")[0];return t.src=this.model.thumbsrc,this.$el.draggable({cursor:"pointer",cursorAt:{top:-10,left:-10},helper:function(){var i=$('<div class="drag-image"><h2>Copy this</h2></div>').data({"meemoo-drag-type":"canvas","meemoo-source-image":t,"meemoo-image-url":e});return $(document.body).append(i),_.delay(function(){s(i)},100),i}}),d.prepend(this.el),this.model.on("destroy",this.remove,this),this},exportPublic:function(){if(!window.filepicker)return r("Image service not available."),!1;var e=this.model.get("files").main.url;filepicker.exportFile(e,{mimetype:"image/png"},function(){})},destroyModel:function(){if(window.confirm("Are you sure you want to delete this image?")){if(window.filepicker){var e=this.model.get("files").main;filepicker.remove(e,function(){})}this.model.destroy()}},remove:function(){this.$el.remove()}});var p=new Iframework.plugins.images.GalleryImages;p.fetch({success:function(){p.each(function(e){e.initializeView()})},error:function(){console.warn("error loading public images")}})}),$(function(){Iframework.allLoaded(),Mousetrap.bind(["command+a","ctrl+a"],function(e){Iframework.shownGraph&&Iframework.shownGraph.view&&(e.preventDefault(),Iframework.shownGraph.view.selectAll())}),Mousetrap.bind(["command+x","ctrl+x"],function(){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework.shownGraph.view.cut()}),Mousetrap.bind(["command+c","ctrl+c"],function(){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework.shownGraph.view.copy()}),Mousetrap.bind(["command+v","ctrl+v"],function(){Iframework.shownGraph&&Iframework.shownGraph.view&&Iframework.shownGraph.view.paste()})});